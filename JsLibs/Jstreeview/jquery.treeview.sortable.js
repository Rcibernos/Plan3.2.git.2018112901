(function(a){if(window.Node&&Node.prototype&&!Node.prototype.contains){Node.prototype.contains=function(b){return !!(this.compareDocumentPosition(b)&16)}}a.widget("ui.sortableTree",a.extend(a.ui.mouse,{init:function(){var c=this,b=this.options;this.containerCache={};this.element.addClass("ui-sortableTree");this.refresh();if(!(/(relative|absolute|fixed)/).test(this.element.css("position"))){this.element.css("position","relative")}this.offset=this.element.offset();this.mouseInit();if(b.cursorAt&&b.cursorAt.constructor==Array){b.cursorAt={left:b.cursorAt[0],top:b.cursorAt[1]}}},plugins:{},ui:function(b){return{helper:(b||this)["helper"],position:(b||this)["position"].current,absolutePosition:(b||this)["position"].absolute,instance:this,options:this.options,element:this.element,item:(b||this)["currentItem"],sender:b?b.element:null}},propagate:function(d,b,c){a.ui.plugin.call(this,d,[b,this.ui(c)]);this.element.triggerHandler(d=="sort"?d:"sort"+d,[b,this.ui(c)],this.options[d])},serialize:function(c){var b=a(this.options.items,this.element).not(".ui-sortableTree-helper");var d=[];c=c||{};b.each(function(){var e=(a(this).attr(c.attribute||"id")||"").match(c.expression||(/(.+)[-=_](.+)/));if(e){d.push((c.key||e[1])+"[]="+(c.key?e[1]:e[2]))}});return d.join("&")},toArray:function(b){var c=a(this.options.items,this.element).not(".ui-sortableTree-helper");var d=[];c.each(function(){d.push(a(this).attr(b||"id"))});return d},enable:function(){this.element.removeClass("ui-sortableTree-disabled");this.options.disabled=false},disable:function(){this.element.addClass("ui-sortableTree-disabled");this.options.disabled=true},intersectsWith:function(d){var h=this.position.absolute.left-10,i=h+10,j=this.position.absolute.top-10,k=j+10;var e=d.left,f=e+d.width,g=d.top,c=g+d.height;return(e<h+(this.helperProportions.width/2)&&i-(this.helperProportions.width/2)<f&&g<j+(this.helperProportions.height/2)&&k-(this.helperProportions.height/2)<c)},intersectsWithEdge:function(d){var f=this.position.absolute.top-10,g=f+10;var e=d.top,c=e+d.height;if(!this.intersectsWith(d.item.parents(".ui-sortableTree").data("sortableTree").containerCache)){return false}if(!(e<f+(this.helperProportions.height/2)&&g-(this.helperProportions.height/2)<c)){return false}if(g>e&&f<e){return 1}if(f<c&&g>c){return 2}return false},refresh:function(){this.refreshItems();this.refreshPositions()},refreshItems:function(){this.items=[];this.containers=[this];var e=this.items;var g=[a(this.options.items,this.element)];if(this.options.connectWith){for(var c=this.options.connectWith.length-1;c>=0;c--){var b=a(this.options.connectWith[c]);for(var f=b.length-1;f>=0;f--){var d=a.data(b[f],"sortableTree");if(d&&!d.options.disabled){g.push(a(d.options.items,d.element));this.containers.push(d)}}}}for(var c=g.length-1;c>=0;c--){g[c].each(function(){a.data(this,"sortableTree-item",true);e.push({item:a(this),width:0,height:0,left:0,top:0})})}},refreshPositions:function(b){for(var c=this.items.length-1;c>=0;c--){if(!b){this.items[c].height=this.items[c].item.outerHeight()}this.items[c].top=this.items[c].item.offset().top}for(var c=this.containers.length-1;c>=0;c--){var d=this.containers[c].element.offset();this.containers[c].containerCache.left=d.left;this.containers[c].containerCache.top=d.top;this.containers[c].containerCache.width=this.containers[c].element.outerWidth();this.containers[c].containerCache.height=this.containers[c].element.outerHeight()}},destroy:function(){this.element.removeClass("ui-sortableTree ui-sortableTree-disabled").removeData("sortableTree").unbind(".sortableTree");this.mouseDestroy();for(var b=this.items.length-1;b>=0;b--){this.items[b].item.removeData("sortableTree-item")}},contactContainers:function(f){for(var g=this.containers.length-1;g>=0;g--){if(this.intersectsWith(this.containers[g].containerCache)){if(!this.containers[g].containerCache.over){if(this.currentContainer!=this.containers[g]){var d=10000;var h=null;var b=this.position.absolute.top;for(var k=this.items.length-1;k>=0;k--){if(!this.containers[g].element[0].contains(this.items[k].item[0])){continue}var c=this.items[k].top;if(Math.abs(c-b)<d){d=Math.abs(c-b);h=this.items[k]}}h?this.rearrange(f,h):this.rearrange(f,null,this.containers[g].element);this.propagate("change",f);this.containers[g].propagate("change",f,this);this.currentContainer=this.containers[g]}this.containers[g].propagate("over",f,this);this.containers[g].containerCache.over=1}}else{if(this.containers[g].containerCache.over){this.containers[g].propagate("out",f,this);this.containers[g].containerCache.over=0}}}},mouseStart:function(c,d){if(this.options.disabled||this.options.type=="static"){return false}var b=null,g=a(c.target).parents().each(function(){if(a.data(this,"sortableTree-item")){b=a(this);return false}});if(a.data(c.target,"sortableTree-item")){b=a(c.target)}if(!b){return false}if(this.options.handle){var j=false;a(this.options.handle,b).each(function(){if(this==c.target){j=true}});if(!j){return false}}this.currentItem=b;var h=this.options;this.currentContainer=this;this.refresh();this.helper=typeof h.helper=="function"?a(h.helper.apply(this.element[0],[c,this.currentItem])):this.currentItem.clone();if(!this.helper.parents("body").length){this.helper.appendTo("body")}this.helper.css({position:"absolute",clear:"both"}).addClass("ui-sortableTree-helper");a.extend(this,{offsetParent:this.helper.offsetParent(),offsets:{absolute:this.currentItem.offset()}});a.extend(this,{position:{current:{left:c.pageX,top:c.pageY},absolute:{left:c.pageX,top:c.pageY},dom:this.currentItem.prev()[0]},clickOffset:{left:-5,top:-5}});this.propagate("start",c);this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()};for(var f=this.containers.length-1;f>=0;f--){this.containers[f].propagate("activate",c,this)}if(a.ui.ddmanager){a.ui.ddmanager.current=this}if(a.ui.ddmanager&&!h.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,c)}this.dragging=true;return true},mouseStop:function(c){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}this.propagate("stop",c);var b=(a.ui.ddmanager&&!this.options.dropBehaviour)?a.ui.ddmanager.drop(this,c):false;if(!b&&this.newPositionAt){this.newPositionAt[this.direction=="down"?"before":"after"](this.currentItem)}if(this.position.dom!=this.currentItem.prev()[0]){this.propagate("update",c)}if(!this.element[0].contains(this.currentItem[0])){this.propagate("remove",c);for(var d=this.containers.length-1;d>=0;d--){if(this.containers[d].element[0].contains(this.currentItem[0])){this.containers[d].propagate("update",c,this);this.containers[d].propagate("receive",c,this)}}}for(var d=this.containers.length-1;d>=0;d--){this.containers[d].propagate("deactivate",c,this);if(this.containers[d].containerCache.over){this.containers[d].propagate("out",c,this);this.containers[d].containerCache.over=0}}this.dragging=false;if(this.cancelHelperRemoval){return false}this.helper.remove();return false},mouseDrag:function(b){this.position.current={top:b.pageY+5,left:b.pageX+5};this.position.absolute={left:b.pageX+5,top:b.pageY+5};if(a.ui.ddmanager){a.ui.ddmanager.drag(this,b)}var f=false;a.each(a.ui.ddmanager.droppables,function(){if(this.isover){f=true}});if(f){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}}else{for(var c=this.items.length-1;c>=0;c--){if(this.currentItem[0].contains(this.items[c].item[0])){continue}var d=this.intersectsWithEdge(this.items[c]);if(!d){continue}this.direction=d==1?"down":"up";this.rearrange(b,this.items[c]);this.propagate("change",b);break}}this.contactContainers(b);this.propagate("sort",b);this.helper.css({left:this.position.current.left+"px",top:this.position.current.top+"px"});return false},rearrange:function(c,d,b){if(d){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}this.newPositionAt=d.item;this.options.sortIndication[this.direction].call(this.currentItem,this.newPositionAt)}else{}}}));a.extend(a.ui.sortableTree,{defaults:{items:"> *",zIndex:1000,distance:1},getter:"serialize toArray"})})(jQuery);