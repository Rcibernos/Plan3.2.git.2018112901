function Ganttalendar(e,d,a,b,c){this.master=b;this.element;this.highlightBar;this.zoom=e;this.minGanttSize=c;this.includeToday=true;this.showCriticalPath=false;this.zoomLevels=["d","w","m","q","s","y"];this.element=this.create(e,d,a)}Ganttalendar.prototype.zoomGantt=function(b){var a=this.zoom;var d=this.zoomLevels.indexOf(a+"");var c=d;if(b){c=d<=0?0:d-1}else{c=d>=this.zoomLevels.length-1?this.zoomLevels.length-1:d+1}if(c!=d){a=this.zoomLevels[c];this.zoom=a;this.refreshGantt()}};Ganttalendar.prototype.create=function(k,f,e){var h=this;function d(p,o,m){var n=new Date(o);var l=new Date(m);if(p=="d"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setFirstDayOfThisWeek();l.setFirstDayOfThisWeek();l.setDate(l.getDate()+6)}else{if(p=="w"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setFirstDayOfThisWeek();l.setFirstDayOfThisWeek();l.setDate(l.getDate()+6)}else{if(p=="m"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);l.setDate(1);l.setMonth(l.getMonth()+1);l.setDate(l.getDate()-1)}else{if(p=="q"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);n.setMonth(Math.floor(n.getMonth()/3)*3);l.setDate(1);l.setMonth(Math.floor(l.getMonth()/3)*3+3);l.setDate(l.getDate()-1)}else{if(p=="s"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);n.setMonth(Math.floor(n.getMonth()/6)*6);l.setDate(1);l.setMonth(Math.floor(l.getMonth()/6)*6+6);l.setDate(l.getDate()-1)}else{if(p=="y"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);n.setMonth(0);l.setDate(1);l.setMonth(12);l.setDate(l.getDate()-1)}}}}}}return{start:n.getTime(),end:l.getTime()}}function c(m,n,l,p){var o=$("<th>").html(m).attr("colSpan",n);if(p){o.width(p)}if(l){o.addClass(l)}return o}function a(o,m,l){var n=$("<td>").html("").attr("colSpan",o).addClass("ganttBodyCell");if(m){n.addClass("end")}if(l){n.addClass(l)}return n}function b(A,s,n){var v=$("<tr>").addClass("ganttHead1");var w=$("<tr>").addClass("ganttHead2");var y=$("<tr>").addClass("ganttBody");function q(x,B){var C=new Date(s);while(C.getTime()<=n){x(C)}C=new Date(s);while(C.getTime()<=n){B(C)}}var m;if(A=="y"){m=Math.floor(((n-s)/(3600000*24*180))*100);q(function(x){v.append(c(x.format("yyyy"),2));x.setFullYear(x.getFullYear()+1)},function(x){var B=(Math.floor(x.getMonth()/6)+1);w.append(c(GanttMaster.messages.GANTT_SEMESTER_SHORT+B,1,null,100));y.append(a(1,B==2));x.setMonth(x.getMonth()+6)})}else{if(A=="s"){m=Math.floor(((n-s)/(3600000*24*90))*100);q(function(x){var B=new Date(x.getTime());B.setMonth(B.getMonth()+6);B.setDate(B.getDate()-1);v.append(c(x.format("MMM")+" - "+B.format("MMM yyyy"),2));x.setMonth(x.getMonth()+6)},function(x){var B=(Math.floor(x.getMonth()/3)+1);w.append(c(GanttMaster.messages.GANTT_QUARTER_SHORT+B,1,null,100));y.append(a(1,B%2==0));x.setMonth(x.getMonth()+3)})}else{if(A=="q"){m=Math.floor(((n-s)/(3600000*24*30))*300);q(function(x){var B=new Date(x.getTime());B.setMonth(B.getMonth()+3);B.setDate(B.getDate()-1);v.append(c(x.format("MMM")+" - "+B.format("MMM yyyy"),3));x.setMonth(x.getMonth()+3)},function(x){var B=x.format("MMM");w.append(c(B,1,null,300));y.append(a(1,x.getMonth()%3==2));x.setMonth(x.getMonth()+1)})}else{if(A=="m"){m=Math.floor(((n-s)/(3600000*24*1))*25);q(function(x){var C=x.getTime();x.setMonth(x.getMonth()+1);var B=Math.round((x.getTime()-C)/(3600000*24));v.append(c(new Date(C).format("MMMM yyyy"),B))},function(x){w.append(c(x.format("d"),1,isHoliday(x)?"holyH":null,25));var B=new Date(x.getTime());B.setDate(x.getDate()+1);y.append(a(1,B.getDate()==1,isHoliday(x)?"holy":null));x.setDate(x.getDate()+1)})}else{if(A=="w"){m=Math.floor(((n-s)/(3600000*24))*40);q(function(x){var B=new Date(x.getTime());B.setDate(B.getDate()+6);v.append(c(x.format("MMM d")+" - "+B.format("MMM d'yy"),7));x.setDate(x.getDate()+7)},function(x){w.append(c(x.format("EEEE").substr(0,1),1,isHoliday(x)?"holyH":null,40));y.append(a(1,x.getDay()%7==(h.master.firstDayOfWeek+6)%7,isHoliday(x)?"holy":null));x.setDate(x.getDate()+1)})}else{if(A=="d"){m=Math.floor(((n-s)/(3600000*24))*100);q(function(x){var B=new Date(x.getTime());B.setDate(B.getDate()+6);v.append(c(x.format("MMMM d")+" - "+B.format("MMMM d yyyy"),7));x.setDate(x.getDate()+7)},function(x){w.append(c(x.format("EEE d"),1,isHoliday(x)?"holyH":null,100));y.append(a(1,x.getDay()%7==(h.master.firstDayOfWeek+6)%7,isHoliday(x)?"holy":null));x.setDate(x.getDate()+1)})}else{console.error("Wrong level "+A)}}}}}}m=Math.max(m,h.minGanttSize);var t=$("<table cellspacing=0 cellpadding=0>");t.append(v).append(w).css({width:m});var o=t.clone().addClass("fixHead");t.append(y).addClass("ganttTable");t.height(h.master.editor.element.height());var l=$("<div>");l.addClass("gantt unselectable").attr("unselectable","true").css({position:"relative",width:m});l.append(t);l.append(o);var p=$("<div>").addClass("ganttHighLight");l.append(p);h.highlightBar=p;var r=$("<div>");r.addClass("ganttLinks").css({position:"absolute",top:0,width:m,height:"100%"});l.append(r);h.fx=m/(n-s);if(new Date().getTime()>h.startMillis&&new Date().getTime()<h.endMillis){var z=Math.round(((new Date().getTime())-h.startMillis)*h.fx);var u=$("<div>").addClass("ganttToday").css("left",z);l.append(u)}return l}if(this.includeToday){var j=new Date().getTime();f=f>j?j:f;e=e<j?j:e}var g=d(k,f,e);h.startMillis=g.start;h.endMillis=g.end;h.originalStartMillis=f;h.originalEndMillis=e;var i=b(k,g.start,g.end);return i};Ganttalendar.prototype.drawTask=function(b){var a=this;editorRow=b.rowElement;var e=editorRow.position().top+editorRow.offsetParent().scrollTop();var f=Math.round((b.start-a.startMillis)*a.fx);var c=$.JST.createFromTemplate(b,"TASKBAR");b.ganttElement=c;if(b.isParent()){c.addClass("hasChild")}c.css({top:e,left:f,width:Math.round((b.end-b.start)*a.fx)});if(this.master.canWrite&&b.canWrite){c.resizable({handles:"e"+(b.depends?"":",w"),resize:function(g,h){$(".taskLabel[taskId="+h.helper.attr("taskId")+"]").css("width",h.position.left);g.stopImmediatePropagation();g.stopPropagation()},stop:function(h,k){var j=a.master.getTask(k.element.attr("taskId"));var i=Math.round((k.position.left/a.fx)+a.startMillis);var g=Math.round(((k.position.left+k.size.width)/a.fx)+a.startMillis);a.master.beginTransaction();a.master.changeTaskDates(j,new Date(i),new Date(g));a.master.endTransaction()}}).on("mouseup",function(){$(":focus").blur()})}c.dblclick(function(){a.master.showTaskEditor($(this).closest("[taskId]").attr("taskId"))}).mousedown(function(){var g=a.master.getTask($(this).attr("taskId"));g.rowElement.click()});if(!b.depends&&this.master.canWrite&&b.canWrite){c.css("position","absolute").draggable({axis:"x",drag:function(g,h){$(".taskLabel[taskId="+$(this).attr("taskId")+"]").css("width",h.position.left)},stop:function(g,j){var i=a.master.getTask($(this).attr("taskId"));var h=Math.round((j.position.left/a.fx)+a.startMillis);a.master.beginTransaction();a.master.moveTask(i,new Date(h));a.master.endTransaction()}})}var d=$("<div class='ganttLines'></div>");d.css({top:e+d.height()});a.element.append(c);a.element.append(d);a.redrawLinks()};Ganttalendar.prototype.addTask=function(a){this.originalEndMillis=this.originalEndMillis>a.end?this.originalEndMillis:a.end;this.originalStartMillis=this.originalStartMillis<a.start?this.originalStartMillis:a.start};Ganttalendar.prototype.drawLink=function(d,i,j){var f=10;var e=2;HLine=function(n,m,l){var k=$("<div>").addClass("taskDepLine");k.css({height:e,left:l,width:n,top:m-e/2});return k};VLine=function(k,m,l){var n=$("<div>").addClass("taskDepLine");n.css({height:k,left:l-e/2,width:e,top:m});return n};function a(k){var l=k.ganttElement.position();l.width=k.ganttElement.width();l.height=k.ganttElement.height();return l}function b(z,A,y){var w,B;var x=$("<div>").attr({from:d.id,to:i.id});var l=z.left+z.width;var m=z.height/2+z.top;var C=(l+2*y)<A.left;if(!C){if(y>0){var n=new HLine(y,m,l);l=l+y;x.append(n)}var q=((A.top+A.height/2)-(z.top+z.height/2))/2;var p;if(q<0){p=new VLine(-q,m+q,l)}else{p=new VLine(q,m,l)}m=m+q;x.append(p);var t=z.left+z.width+y-(A.left-y);l=l-t;var s=new HLine(t,m,l);x.append(s);var u;if(q<0){u=new VLine(-q,m+q,l)}else{u=new VLine(q,m,l)}x.append(u);m=m+q;if(y>0){var v=new HLine(y,m,l);l=l+y;x.append(v)}}else{var o=(A.left-l)/2;var n=new HLine(o,m,l);l=l+o;x.append(n);var r=((A.top+A.height/2)-(z.top+z.height/2));var p;if(r<0){p=new VLine(-r,m+r,l)}else{p=new VLine(r,m,l)}x.append(p);m=m+r;var s=new HLine(o,m,l);l=l+o;x.append(s)}var k=$("<img src='res/linkArrow.png'>").css({position:"absolute",top:A.top+A.height/2-5,left:A.left-5});x.append(k);return x}function c(y,z,x){var v,A;var w=$("<div>").attr({from:d.id,to:i.id});var l=y.left;var m=y.height/2+y.top;var B=(l+2*x)<z.left;if(!B){if(x>0){var n=new HLine(x,m,l-x);l=l-x;w.append(n)}var p=((z.top+z.height/2)-(y.top+y.height/2))/2;var o;if(p<0){o=new VLine(-p,m+p,l)}else{o=new VLine(p,m,l)}m=m+p;w.append(o);var s=(y.left-x)-(z.left-x);l=l-s;var r=new HLine(s,m,l);w.append(r);var t;if(p<0){t=new VLine(-p,m+p,l)}else{t=new VLine(p,m,l)}w.append(t);m=m+p;if(x>0){var u=new HLine(x,m,l);l=l+x;w.append(u)}}else{var n=new HLine(x,m,l-x);l=l-x;w.append(n);var q=((z.top+z.height/2)-(y.top+y.height/2));var o;if(q<0){o=new VLine(-q,m+q,l)}else{o=new VLine(q,m,l)}w.append(o);m=m+q;var r=new HLine(l+x+(z.left-y.left),m,l);l=l+x+(z.left-y.left);w.append(r)}var k=$("<img src='res/linkArrow.png'>").css({position:"absolute",top:z.top+z.height/2-5,left:z.left-5});w.append(k);return w}var g=a(d);var h=a(i);if(j=="start-to-start"){this.element.find(".ganttLinks").append(c(g,h,f))}else{this.element.find(".ganttLinks").append(b(g,h,f))}};Ganttalendar.prototype.redrawLinks=function(){var a=this;this.element.stopTime("ganttlnksredr");this.element.oneTime(60,"ganttlnksredr",function(){a.element.find(".ganttLinks").empty();var b=a.master.getCollapsedDescendant();for(var c=0;c<a.master.links.length;c++){var d=a.master.links[c];if(b.indexOf(d.from)>=0||b.indexOf(d.to)>=0){continue}a.drawLink(d.from,d.to)}})};Ganttalendar.prototype.reset=function(){this.element.find(".ganttLinks").empty();this.element.find("[taskId]").remove()};Ganttalendar.prototype.redrawTasks=function(){var a=this.master.getCollapsedDescendant();for(var b=0;b<this.master.tasks.length;b++){var c=this.master.tasks[b];if(a.indexOf(c)>=0){continue}this.drawTask(c)}};Ganttalendar.prototype.refreshGantt=function(){var c=this.element.parent();var e=c.scrollTop();var d=c.scrollLeft();this.element.remove();if(!this.zoom){var a=Math.round((this.originalEndMillis-this.originalStartMillis)/(3600000*24));this.zoom=this.zoomLevels[a<2?0:(a<15?1:(a<60?2:(a<150?3:4)))]}var b=this.create(this.zoom,this.originalStartMillis,this.originalEndMillis);this.element=b;c.append(b);this.redrawTasks();this.synchHighlight();c.scrollTop(e);c.scrollLeft(d);if(this.showCriticalPath){this.master.computeCriticalPath();this.gantt.showCriticalPath()}};Ganttalendar.prototype.fitGantt=function(){delete this.zoom;this.refreshGantt()};Ganttalendar.prototype.synchHighlight=function(){if(this.master.currentTask&&this.master.currentTask.ganttElement){this.highlightBar.css("top",this.master.currentTask.ganttElement.css("top"))}};Ganttalendar.prototype.centerOnToday=function(){var a=Math.round(((new Date().getTime())-this.startMillis)*this.fx)-30;this.element.parent().scrollLeft(a)};Ganttalendar.prototype.showCriticalPath=function(){console.error("To be implemented")};