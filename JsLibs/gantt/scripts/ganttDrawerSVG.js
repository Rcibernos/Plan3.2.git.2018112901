function Ganttalendar(e,d,a,b,c){this.master=b;this.element;this.highlightBar;this.svg;this.tasksGroup;this.linksGroup;this.zoom=e;this.minGanttSize=c;this.includeToday=true;this.showCriticalPath=false;this.zoomLevels=["d","w","m","q","s","y"];this.element=this.create(e,d,a);this.linkOnProgress=false}Ganttalendar.prototype.zoomGantt=function(b){var a=this.zoom;var d=this.zoomLevels.indexOf(a+"");var c=d;if(b){c=d<=0?0:d-1}else{c=d>=this.zoomLevels.length-1?this.zoomLevels.length-1:d+1}if(c!=d){a=this.zoomLevels[c];this.zoom=a;this.refreshGantt()}};Ganttalendar.prototype.create=function(k,f,e){var h=this;function d(p,o,m){var n=new Date(o);var l=new Date(m);if(p=="d"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setFirstDayOfThisWeek();l.setFirstDayOfThisWeek();l.setDate(l.getDate()+6)}else{if(p=="w"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setFirstDayOfThisWeek();l.setFirstDayOfThisWeek();l.setDate(l.getDate()+6)}else{if(p=="m"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);l.setDate(1);l.setMonth(l.getMonth()+1);l.setDate(l.getDate()-1)}else{if(p=="q"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);n.setMonth(Math.floor(n.getMonth()/3)*3);l.setDate(1);l.setMonth(Math.floor(l.getMonth()/3)*3+3);l.setDate(l.getDate()-1)}else{if(p=="s"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);n.setMonth(Math.floor(n.getMonth()/6)*6);l.setDate(1);l.setMonth(Math.floor(l.getMonth()/6)*6+6);l.setDate(l.getDate()-1)}else{if(p=="y"){n.setHours(0,0,0,0);l.setHours(23,59,59,999);n.setDate(1);n.setMonth(0);l.setDate(1);l.setMonth(12);l.setDate(l.getDate()-1)}}}}}}return{start:n.getTime(),end:l.getTime()}}function c(m,n,l,p){var o=$("<th>").html(m).attr("colSpan",n);if(p){o.width(p)}if(l){o.addClass(l)}return o}function a(o,m,l){var n=$("<td>").html("").attr("colSpan",o).addClass("ganttBodyCell");if(m){n.addClass("end")}if(l){n.addClass(l)}return n}function b(y,t,n){var v=$("<tr>").addClass("ganttHead1");var w=$("<tr>").addClass("ganttHead2");var x=$("<tr>").addClass("ganttBody");function r(z,A){var B=new Date(t);while(B.getTime()<=n){z(B)}B=new Date(t);while(B.getTime()<=n){A(B)}}var m;if(y=="y"){m=Math.floor(((n-t)/(3600000*24*180))*100);r(function(z){v.append(c(z.format("yyyy"),2));z.setFullYear(z.getFullYear()+1)},function(z){var A=(Math.floor(z.getMonth()/6)+1);w.append(c(GanttMaster.messages.GANTT_SEMESTER_SHORT+A,1,null,100));x.append(a(1,A==2));z.setMonth(z.getMonth()+6)})}else{if(y=="s"){m=Math.floor(((n-t)/(3600000*24*90))*100);r(function(z){var A=new Date(z.getTime());A.setMonth(A.getMonth()+6);A.setDate(A.getDate()-1);v.append(c(z.format("MMM")+" - "+A.format("MMM yyyy"),2));z.setMonth(z.getMonth()+6)},function(z){var A=(Math.floor(z.getMonth()/3)+1);w.append(c(GanttMaster.messages.GANTT_QUARTER_SHORT+A,1,null,100));x.append(a(1,A%2==0));z.setMonth(z.getMonth()+3)})}else{if(y=="q"){m=Math.floor(((n-t)/(3600000*24*30))*300);r(function(z){var A=new Date(z.getTime());A.setMonth(A.getMonth()+3);A.setDate(A.getDate()-1);v.append(c(z.format("MMM")+" - "+A.format("MMM yyyy"),3));z.setMonth(z.getMonth()+3)},function(z){var A=z.format("MMM");w.append(c(A,1,null,300));x.append(a(1,z.getMonth()%3==2));z.setMonth(z.getMonth()+1)})}else{if(y=="m"){m=Math.floor(((n-t)/(3600000*24*1))*25);r(function(z){var B=z.getTime();z.setMonth(z.getMonth()+1);var A=Math.round((z.getTime()-B)/(3600000*24));v.append(c(new Date(B).format("MMMM yyyy"),A))},function(z){w.append(c(z.format("d"),1,isHoliday(z)?"holyH":null,25));var A=new Date(z.getTime());A.setDate(z.getDate()+1);x.append(a(1,A.getDate()==1,isHoliday(z)?"holy":null));z.setDate(z.getDate()+1)})}else{if(y=="w"){m=Math.floor(((n-t)/(3600000*24))*40);r(function(z){var A=new Date(z.getTime());A.setDate(A.getDate()+6);v.append(c(z.format("MMM d")+" - "+A.format("MMM d'yy"),7));z.setDate(z.getDate()+7)},function(z){w.append(c(z.format("EEEE").substr(0,1),1,isHoliday(z)?"holyH":null,40));x.append(a(1,z.getDay()%7==(h.master.firstDayOfWeek+6)%7,isHoliday(z)?"holy":null));z.setDate(z.getDate()+1)})}else{if(y=="d"){m=Math.floor(((n-t)/(3600000*24))*100);r(function(z){var A=new Date(z.getTime());A.setDate(A.getDate()+6);v.append(c(z.format("MMMM d")+" - "+A.format("MMMM d yyyy"),7));z.setDate(z.getDate()+7)},function(z){w.append(c(z.format("EEE d"),1,isHoliday(z)?"holyH":null,100));x.append(a(1,z.getDay()%7==(h.master.firstDayOfWeek+6)%7,isHoliday(z)?"holy":null));z.setDate(z.getDate()+1)})}else{console.error("Wrong level "+y)}}}}}}m=Math.max(m,h.minGanttSize);var u=$("<table cellspacing=0 cellpadding=0>");u.append(v).append(w).css({width:m});var o=u.clone().addClass("fixHead");u.append(x).addClass("ganttTable");var p=h.master.editor.element.height();u.height(p);var l=$("<div>");l.addClass("gantt unselectable").attr("unselectable","true").css({position:"relative",width:m});l.append(u);l.append(o);var q=$("<div>").addClass("ganttHighLight");l.append(q);h.highlightBar=q;var s=30;l.svg({settings:{"class":"ganttSVGBox"},onLoad:function(D){var z=D.defs("myDefs");D.linearGradient(z,"taskGrad",[[0,"#ddd"],[0.5,"#fff"],[1,"#ddd"]],0,0,0,"100%");var A=D.pattern(z,"extDep",0,0,40,40,0,0,40,40,{patternUnits:"userSpaceOnUse"});D.image(A,0,0,40,40,"res/hasExternalDeps.png");h.svg=D;$(D).addClass("ganttSVGBox");var B=D.group("gridGroup");for(var C=40;C<=p;C+=s){D.line(B,0,C,"100%",C,{"class":"ganttLinesSVG"})}h.linksGroup=D.group("linksGroup");h.tasksGroup=D.group("tasksGroup");h.fx=m/(n-t);if(new Date().getTime()>h.startMillis&&new Date().getTime()<h.endMillis){var E=Math.round(((new Date().getTime())-h.startMillis)*h.fx);D.line(B,E,0,E,"100%",{"class":"ganttTodaySVG"})}}});return l}if(this.includeToday){var j=new Date().getTime();f=f>j?j:f;e=e<j?j:e}var g=d(k,f,e);h.startMillis=g.start;h.endMillis=g.end;h.originalStartMillis=f;h.originalEndMillis=e;var i=b(k,g.start,g.end);return i};Ganttalendar.prototype.drawTask=function(c){var b=this;editorRow=c.rowElement;var e=editorRow.position().top+editorRow.offsetParent().scrollTop();var f=Math.round((c.start-b.startMillis)*b.fx);c.hasChild=c.isParent();var d=$(a(c,{x:f,y:e,width:Math.round((c.end-c.start)*b.fx)}));c.ganttElement=d;if(b.showCriticalPath&&c.isCritical){d.addClass("critical")}d.click(function(g){g.stopPropagation();b.element.find(".focused").removeClass("focused");$(".ganttSVGBox .focused").removeClass("focused");var h=$(this);if(!b.resDrop){h.addClass("focused")}b.resDrop=false;$("body").off("click.focused").one("click.focused",function(){$(".ganttSVGBox .focused").removeClass("focused")})}).dblclick(function(){b.master.showTaskEditor($(this).attr("taskid"))}).mouseenter(function(){var g=$(this);if(!b.linkOnProgress){g.find(".linkHandleSVG").show()}else{g.addClass("linkOver")}}).mouseleave(function(){var g=$(this);g.removeClass("linkOver").find(".linkHandleSVG").hide()}).mouseup(function(g){$(":focus").blur()}).mousedown(function(){var g=b.master.getTask($(this).attr("taskId"));g.rowElement.click()}).dragExtedSVG($(b.svg.root()),{canResize:this.master.canWrite&&c.canWrite,canDrag:!c.depends&&this.master.canWrite&&c.canWrite,startDrag:function(g){$(".ganttSVGBox .focused").removeClass("focused")},drag:function(g){$("[from="+c.id+"],[to="+c.id+"]").trigger("update")},drop:function(g){b.resDrop=true;var j=$(this);var i=b.master.getTask(j.attr("taskid"));var h=Math.round((parseFloat(j.attr("x"))/b.fx)+b.startMillis);b.master.beginTransaction();b.master.moveTask(i,new Date(h));b.master.endTransaction()},startResize:function(g){$(".ganttSVGBox .focused").removeClass("focused");var h=$(this);var i=$(b.svg.text(parseInt(h.attr("x"))+parseInt(h.attr("width")+8),parseInt(h.attr("y")),"",{"font-size":"10px",fill:"red"}));d.data("textDur",i)},resize:function(h){var k=$(this);var j=Math.round((parseFloat(k.attr("x"))/b.fx)+b.startMillis);var i=Math.round(((parseFloat(k.attr("x"))+parseFloat(k.attr("width")))/b.fx)+b.startMillis);var g=computeStartDate(j).distanceInWorkingDays(computeEndDate(i));var l=d.data("textDur");l.attr("x",parseInt(k.attr("x"))+parseInt(k.attr("width"))+8).html(g);$("[from="+c.id+"],[to="+c.id+"]").trigger("update")},stopResize:function(g){b.resDrop=true;var l=d.data("textDur");if(l){l.remove()}var k=$(this);var j=b.master.getTask(k.attr("taskid"));var i=Math.round((parseFloat(k.attr("x"))/b.fx)+b.startMillis);var h=Math.round(((parseFloat(k.attr("x"))+parseFloat(k.attr("width")))/b.fx)+b.startMillis);b.master.beginTransaction();b.master.changeTaskDates(j,new Date(i),new Date(h));b.master.endTransaction()}});d.find(".linkHandleSVG").mousedown(function(h){h.preventDefault();h.stopPropagation();var n=$(this).closest(".taskBoxSVG");var m=$(b.svg.root());var j=m.offset();b.linkOnProgress=true;b.linkFromEnd=$(this).is(".taskLinkEndSVG");m.addClass("linkOnProgress");var k=parseFloat(n.attr("x"))+(b.linkFromEnd?parseFloat(n.attr("width")):0);var l=parseFloat(n.attr("y"))+parseFloat(n.attr("height"))/2;var i=b.svg.line(k,l,h.pageX-j.left-5,h.pageY-j.top-5,{"class":"linkLineSVG"});var g=b.svg.circle(k,l,5,{"class":"linkLineSVG"});m.bind("mousemove.linkSVG",function(p){var s=m.offset();var q=p.pageX-s.left;var r=p.pageY-s.top;var o=Math.sqrt(Math.pow(q-k,2)+Math.pow(r-l,2));q=q-(q-k)*10/o;r=r-(r-l)*10/o;b.svg.change(i,{x2:q,y2:r});b.svg.change(g,{cx:q,cy:r})});$("body").one("mouseup.linkSVG",function(p){$(i).remove();$(g).remove();b.linkOnProgress=false;m.removeClass("linkOnProgress");$(b.svg.root()).unbind("mousemove.linkSVG");var r=$(p.target).closest(".taskBoxSVG");if(r&&r.attr("taskid")!=n.attr("taskid")){var t;var s;if(b.linkFromEnd){t=b.master.getTask(r.attr("taskid"));s=b.master.getTask(n.attr("taskid"))}else{s=b.master.getTask(r.attr("taskid"));t=b.master.getTask(n.attr("taskid"))}if(t&&s){var q=0;var o=t.rowElement.find("[name=depends]");o.val(o.val()+((o.val()+"").length>0?",":"")+(s.getRow()+1)+(q!=0?":"+q:""));o.blur()}}})});b.redrawLinks();function a(k,g){var j=b.svg;var l=j.svg(b.tasksGroup,g.x,g.y,g.width,25,{"class":"taskBox taskBoxSVG",taskid:k.id});var h=j.rect(l,0,0,"100%","100%",{"class":"taskLayout",rx:"6",ry:"6"});if(k.hasExternalDep){h.style.fill="url(#extDep)"}else{h.style.fill="url(#taskGrad)"}if(k.progress>0){var i=j.rect(l,0,0,(k.progress>100?100:k.progress)+"%","100%",{fill:(k.progress>100?"red":"rgb(153,255,51)"),rx:"6",ry:"6",opacity:0.4});if(g.width>50){var m={fill:"#888","font-size":"10px"};if(k.progress>90){m.transform="translate(-30)"}j.text(l,(k.progress>90?100:k.progress)+"%",18,k.progress+"%",m)}}if(g.width>15){j.rect(l,6,6,13,13,{stroke:1,rx:"2",ry:"2",status:k.status,"class":"taskStatusSVG"})}if(k.hasChild){j.rect(l,0,0,"100%",3,{fill:"#000"})}if(k.startIsMilestone){j.image(l,-9,4,18,18,"res/milestone.png")}if(k.endIsMilestone){j.image(l,"100%",4,18,18,"res/milestone.png",{transform:"translate(-9)"})}j.text(l,"100%",18,k.name,{"class":"taskLabelSVG",transform:"translate(8,-8)"});j.circle(l,"0",12,4,{"class":"taskLinkStartSVG linkHandleSVG",transform:"translate(0)"});j.circle(l,"100%",12,4,{"class":"taskLinkEndSVG linkHandleSVG",transform:"translate(0)"});return l}};Ganttalendar.prototype.addTask=function(a){this.originalEndMillis=this.originalEndMillis>a.end?this.originalEndMillis:a.end;this.originalStartMillis=this.originalStartMillis<a.start?this.originalStartMillis:a.start};Ganttalendar.prototype.drawLink=function(d,h,i){var g=this;var f=10;function a(j){var k=j.ganttElement.position();var l={left:parseFloat(j.ganttElement.attr("x")),top:parseFloat(j.ganttElement.attr("y")),width:parseFloat(j.ganttElement.attr("width")),height:parseFloat(j.ganttElement.attr("height"))};return l}function b(j,q,n){var o=g.svg;function r(){var A=$(this);var v=A.data("from");var H=A.data("to");var F=a(v);var G=a(H);var x=F.left;var y=F.left+F.width;var z=F.height/2+F.top;var J=G.left;var K=G.left+G.width;var L=G.height/2+G.top;var I=J<y+2*n;var E=5;var s=5;var M=z>L;var w=M?-1:1;var D=y+2*n>J;var u=D?-1:1;var B=A.find("image");var C=o.createPath();if(I){var t=w*(F.height/2-2*E+2);C.move(y,z).line(n,0,true).arc(E,E,90,false,!M,E,w*E,true).line(0,t,true).arc(E,E,90,false,!M,-E,w*E,true).line(u*2*n+(J-y),0,true).arc(E,E,90,false,M,-E,w*E,true).line(0,(Math.abs(L-z)-4*E-Math.abs(t))*w-s,true).arc(E,E,90,false,M,E,w*E,true).line(n,0,true);B.attr({x:J-5,y:L-5-s})}else{C.move(y,z).line((J-y)/2-E,0,true).arc(E,E,90,false,!M,E,w*E,true).line(0,L-z-w*2*E+s,true).arc(E,E,90,false,M,E,w*E,true).line((J-y)/2-E,0,true);B.attr({x:J-5,y:L-5+s})}A.find("path").attr({d:C.path()})}var k=o.group(g.linksGroup,""+j.id+"-"+q.id);o.title(k,j.name+" -> "+q.name);var m=o.createPath();o.image(k,0,0,5,10,"res/linkArrow.png");o.path(k,m,{"class":"taskLinkPathSVG"});var l=$(k).data({from:j,to:q}).attr({from:j.id,to:q.id}).on("update",r).trigger("update");if(g.showCriticalPath&&j.isCritical&&q.isCritical){l.addClass("critical")}l.addClass("linkGroup");return l}function c(j,m){console.error("StartToStart not supported on SVG");var k=a(j);var l=a(m)}var e;if(i=="start-to-start"){e=c(d,h,f)}else{e=b(d,h,f)}e.click(function(j){var k=$(this);j.stopPropagation();g.element.find(".focused").removeClass("focused");$(".ganttSVGBox .focused").removeClass("focused");var k=$(this);if(!g.resDrop){k.addClass("focused")}g.resDrop=false;$("body").off("click.focused").one("click.focused",function(){$(".ganttSVGBox .focused").removeClass("focused")})})};Ganttalendar.prototype.redrawLinks=function(){var a=this;this.element.stopTime("ganttlnksredr");this.element.oneTime(60,"ganttlnksredr",function(){$("#linksSVG").empty();var b=[];var b=a.master.getCollapsedDescendant();for(var c=0;c<a.master.links.length;c++){var d=a.master.links[c];if(b.indexOf(d.from)>=0||b.indexOf(d.to)>=0){continue}a.drawLink(d.from,d.to)}})};Ganttalendar.prototype.reset=function(){this.element.find(".linkGroup").remove();this.element.find("[taskId]").remove()};Ganttalendar.prototype.redrawTasks=function(){var a=this.master.getCollapsedDescendant();for(var b=0;b<this.master.tasks.length;b++){var c=this.master.tasks[b];if(a.indexOf(c)>=0){continue}this.drawTask(c)}};Ganttalendar.prototype.refreshGantt=function(){if(this.showCriticalPath){this.master.computeCriticalPath()}var c=this.element.parent();var e=c.scrollTop();var d=c.scrollLeft();this.element.remove();if(!this.zoom){var a=Math.round((this.originalEndMillis-this.originalStartMillis)/(3600000*24));this.zoom=this.zoomLevels[a<2?0:(a<15?1:(a<60?2:(a<150?3:4)))]}var b=this.create(this.zoom,this.originalStartMillis,this.originalEndMillis);this.element=b;c.append(b);this.redrawTasks();c.scrollTop(e);c.scrollLeft(d);this.synchHighlight()};Ganttalendar.prototype.fitGantt=function(){delete this.zoom;this.refreshGantt()};Ganttalendar.prototype.synchHighlight=function(){if(this.master.currentTask&&this.master.currentTask.ganttElement){this.highlightBar.css("top",this.master.currentTask.ganttElement.attr("y")+"px")}};Ganttalendar.prototype.centerOnToday=function(){var a=Math.round(((new Date().getTime())-this.startMillis)*this.fx)-30;this.element.parent().scrollLeft(a)};$.fn.dragExtedSVG=function(f,b){var h;var g;var d;var c={canDrag:true,canResize:true,resizeZoneWidth:15,minSize:10,startDrag:function(i){},drag:function(i){},drop:function(i){},startResize:function(i){},resize:function(i){},stopResize:function(i){}};$.extend(c,b);this.each(function(){var i=$(this);g=f.parent().offset().left;if(c.canDrag){i.addClass("deSVGdrag")}if(c.canResize||c.canDrag){i.bind("mousedown.deSVG",function(j){if($(j.target).is("image")){j.preventDefault()}h=$(this);var n=parseFloat(i.offset().left);var o=n+parseFloat(i.attr("width"));var l=j.pageX;$("body").unselectable();var m=o-l;if(c.canResize&&(m>=0&&m<=c.resizeZoneWidth)){d=o-j.pageX;h.attr("oldw",h.attr("width"));var k=true;$(f).bind("mousemove.deSVG",function(p){if(k){c.startResize.call(h.get(0),p);k=false}var r=p.pageX;var q=r-n+d;h.attr("width",q<c.minSize?c.minSize:q);c.resize.call(h.get(0),p)});$("body").one("mouseup.deSVG",e)}else{if(c.canDrag){d=parseFloat(h.attr("x"))-j.pageX;h.attr("oldx",h.attr("x"));var k=true;$(f).bind("mousemove.deSVG",function(p){if(k){c.startDrag.call(h.get(0),p);k=false}h.attr("x",d+p.pageX);c.drag.call(h.get(0),p)}).bind("mouseleave.deSVG",a);$("body").one("mouseup.deSVG",a)}}}).bind("mousemove.deSVG",function(j){var k=$(this);var n=k.offset().left;var o=n+parseFloat(k.attr("width"));var l=j.pageX;var m=o-l;if(c.canResize&&(m>=0&&m<=c.resizeZoneWidth)){k.addClass("deSVGhand")}else{k.removeClass("deSVGhand")}}).addClass("deSVG")}});return this;function e(i){$(f).unbind("mousemove.deSVG").unbind("mouseup.deSVG").unbind("mouseleave.deSVG");if(h){c.stopResize.call(h.get(0),i)}h=undefined;$("body").clearUnselectable()}function a(i){$(f).unbind("mousemove.deSVG").unbind("mouseup.deSVG").unbind("mouseleave.deSVG");if(h&&h.attr("oldx")!=h.attr("x")){c.drop.call(h.get(0),i)}h=undefined;$("body").clearUnselectable()}};