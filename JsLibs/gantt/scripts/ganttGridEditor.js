function GridEditor(a){this.master=a;this.gridified=$.gridify($.JST.createFromTemplate({},"TASKSEDITHEAD"));this.element=this.gridified.find(".gdfTable").eq(1)}GridEditor.prototype.fillEmptyLines=function(){var b=new TaskFactory();var e=30-this.element.find(".taskEditRow").size();for(var c=0;c<e;c++){var a=$.JST.createFromTemplate({},"TASKEMPTYROW");var d=this.master;a.click(function(g){var f=$(this);if(!d.canWrite||f.prevAll(".emptyRow").size()>0){return}d.beginTransaction();var h;var j=new Date().getTime();var i=0;if(d.tasks[0]){j=d.tasks[0].start;i=d.tasks[0].level+1}f.prevAll(".emptyRow").andSelf().each(function(){var k=b.build("tmp_fk"+new Date().getTime(),"","",i,j,1);var l=d.addTask(k);h=k});d.endTransaction();h.rowElement.click();h.rowElement.find("[name=name]").focus().blur(function(){var k=$(this);if(k.val()==""){h.name="Task "+(h.getRow()+1);k.val(h.name)}})});this.element.append(a)}};GridEditor.prototype.addTask=function(c,b){this.element.find("[taskId="+c.id+"]").remove();var d=$.JST.createFromTemplate(c,"TASKROW");c.rowElement=d;this.bindRowEvents(c,d);if(typeof(b)!="number"){var a=this.element.find(".emptyRow:first");if(a.size()>0){a.replaceWith(d)}else{this.element.append(d)}}else{var e=this.element.find("tr.taskEditRow").eq(b);if(e.size()>0){e.before(d)}else{this.element.append(d)}}this.element.find(".taskRowIndex").each(function(g,f){$(f).html(g+1)});return d};GridEditor.prototype.refreshExpandStatus=function(c){if(!c){return}var a=c.getChildren();if(a.length>0&&c.rowElement.has(".expcoll").length==0){c.rowElement.find(".exp-controller").addClass("expcoll exp")}else{if(a.length==0&&c.rowElement.has(".expcoll").length>0){c.rowElement.find(".exp-controller").removeClass("expcoll exp")}}var b=c.getParent();if(b&&b.rowElement.has(".expcoll").length==0){b.rowElement.find(".exp-controller").addClass("expcoll exp")}};GridEditor.prototype.refreshTaskRow=function(b){var a=b.rowElement;a.find(".taskRowIndex").html(b.getRow()+1);a.find(".indentCell").css("padding-left",b.level*16+12);a.find("[name=name]").val(b.name);a.find("[name=code]").val(b.code);a.find("[status]").attr("status",b.status);a.find("[name=duration]").val(b.duration);a.find("[name=start]").val(new Date(b.start).format()).updateOldValue();a.find("[name=end]").val(new Date(b.end).format()).updateOldValue();a.find("[name=depends]").val(b.depends);a.find(".taskAssigs").html(b.getAssigsString())};GridEditor.prototype.redraw=function(){for(var a=0;a<this.master.tasks.length;a++){this.refreshTaskRow(this.master.tasks[a])}};GridEditor.prototype.reset=function(){this.element.find("[taskId]").remove()};GridEditor.prototype.bindRowEvents=function(b,c){var a=this;if(this.master.canWrite&&b.canWrite){a.bindRowInputEvents(b,c)}else{c.find("input").attr("readonly",true)}a.bindRowExpandEvents(b,c);c.find(".edit").click(function(){a.openFullEditor(b,c)})};GridEditor.prototype.bindRowExpandEvents=function(b,c){var a=this;c.find(".exp-controller").click(function(){var g=$(this);var k=g.closest("[taskId]").attr("taskId");var j=a.master.getTask(k);var f=j.getDescendant();g.toggleClass("exp");j.collapsed=!g.is(".exp");var e=a.master.getCollapsedDescendant();if(g.is(".exp")){for(var h=0;h<f.length;h++){var d=f[h];if(e.indexOf(d)>=0){continue}d.rowElement.show()}}else{for(var h=0;h<f.length;h++){f[h].rowElement.hide()}}a.master.gantt.refreshGantt()})};GridEditor.prototype.bindRowInputEvents=function(b,c){var a=this;c.find(".date").each(function(){var d=$(this);if(b.depends&&d.attr("name")=="start"){d.attr("readonly","true")}else{d.removeAttr("readonly")}d.click(function(){var e=$(this);e.dateField({inputField:d})});d.blur(function(e){var g=$(this);if(g.isValueChanged()){if(!Date.isValid(g.val())){alert(GanttMaster.messages.INVALID_DATE_FORMAT);g.val(g.getOldValue())}else{var e=Date.parseString(g.val());var j=g.closest("tr");var l=j.attr("taskId");var k=a.master.getTask(l);var i=k.start;var h=k.end;if(g.attr("name")=="start"){i=e.getTime();if(i>=h){var f=new Date(i);h=f.add("d",k.duration).getTime()}a.master.beginTransaction();a.master.moveTask(k,i);a.master.endTransaction()}else{h=e.getTime();if(i>=h){h=i}h=h+3600000*20;a.master.beginTransaction();a.master.changeTaskDates(k,i,h);a.master.endTransaction()}g.updateOldValue()}}})});c.find("input:not(.date)").focus(function(){$(this).updateOldValue()}).blur(function(){var e=$(this);if(e.isValueChanged()){var l=e.closest("tr");var o=l.attr("taskId");var n=a.master.getTask(o);var f=e.attr("name");a.master.beginTransaction();if(f=="depends"){var k=n.depends;n.depends=e.val();if(n.depends){l.find("[name=start]").attr("readonly","true")}else{l.find("[name=start]").removeAttr("readonly")}var h=a.master.updateLinks(n);if(h){var m=n.getSuperiors();for(var g=0;g<m.length;g++){if(!m[g].from.synchronizeStatus()){break}}a.master.changeTaskDates(n,n.start,n.end)}}else{if(f=="duration"){var d=n.duration;d=parseInt(e.val())||1;e.val(d);var j=computeEndByDuration(n.start,d);a.master.changeTaskDates(n,n.start,j)}else{if(f=="name"&&e.val()==""){n.deleteTask()}else{n[f]=e.val()}}}a.master.endTransaction()}});c.find("input").keydown(function(e){var k=$(this);var m=k.parent();var l=m.parent();var d=m.prevAll("td").size();var i=true;switch(e.keyCode){case 37:if(this.selectionEnd==0){m.prev().find("input").focus()}break;case 39:if(this.selectionEnd==this.value.length){m.next().find("input").focus()}break;case 38:var h=l.prev();var j=h.find("td").eq(d);var f=j.find("input");if(f.size()>0){f.focus()}break;case 40:var g=l.next();var j=g.find("td").eq(d);var f=j.find("input");if(f.size()>0){f.focus()}else{g.click()}break;case 36:break;case 35:break;case 9:case 13:break}return i}).focus(function(){$(this).closest("tr").click()});c.find(".taskStatus").click(function(){var e=$(this);var h=e.closest("[taskId]");var g=h.attr("taskId");var f=a.master.getTask(g);var d=$.JST.createFromTemplate({},"CHANGE_STATUS");d.find("[status="+f.status+"]").addClass("selected");d.find(".taskStatus").click(function(i){i.stopPropagation();var j=$(this).attr("status");d.remove();a.master.beginTransaction();f.changeStatus(j);a.master.endTransaction();e.attr("status",f.status)});e.oneTime(3000,"hideChanger",function(){d.remove()});e.append(d)});c.click(function(){var d=$(this);d.closest("table").find(".rowSelected").removeClass("rowSelected");d.addClass("rowSelected");a.master.currentTask=a.master.getTask(d.attr("taskId"));a.master.gantt.synchHighlight();var e=d.position().top;if(e>a.element.parent().height()){d.offsetParent().scrollTop(e-a.element.parent().height()+100)}else{if(e<40){d.offsetParent().scrollTop(d.offsetParent().scrollTop()-40+e)}}})};GridEditor.prototype.openFullEditor=function(k,n){var g=this;var m=n.attr("taskId");var l=$.JST.createFromTemplate({},"TASK_EDITOR");l.find("#name").val(k.name);l.find("#description").val(k.description);l.find("#code").val(k.code);l.find("#progress").val(k.progress?parseFloat(k.progress):0);l.find("#status").attr("status",k.status);if(k.startIsMilestone){l.find("#startIsMilestone").attr("checked",true)}if(k.endIsMilestone){l.find("#endIsMilestone").attr("checked",true)}l.find("#duration").val(k.duration);var j=l.find("#start");j.val(new Date(k.start).format());if(k.depends){j.attr("readonly","true")}else{j.removeAttr("readonly")}l.find("#end").val(new Date(k.end).format());var c=l.find("#assigsTable");c.find("[assigId]").remove();for(var e=0;e<k.assigs.length;e++){var a=k.assigs[e];var b=$.JST.createFromTemplate({task:k,assig:a},"ASSIGNMENT_ROW");c.append(b)}function h(i){var o=parseInt(l.find("#duration").val());i.clearTime();l.find("#end").val(new Date(computeEndByDuration(i.getTime(),o)).format())}function d(o){var p=Date.parseString(l.find("#start").val());o.setHours(23,59,59,999);if(o.getTime()<p.getTime()){var i=parseInt(l.find("#duration").val());p=incrementDateByWorkingDays(o.getTime(),-i);l.find("#start").val(new Date(computeStart(p)).format())}else{l.find("#duration").val(recomputeDuration(p.getTime(),o.getTime()))}}if(!g.master.canWrite||!k.canWrite){l.find("input,textarea").attr("readOnly",true);l.find("input:checkbox,select").attr("disabled",true)}else{l.find("#start").click(function(){$(this).dateField({inputField:$(this),callback:h})}).blur(function(){var i=$(this);if(!Date.isValid(i.val())){alert(GanttMaster.messages.INVALID_DATE_FORMAT);i.val(i.getOldValue())}else{h(Date.parseString(i.val()))}});l.find("#end").click(function(){$(this).dateField({inputField:$(this),callback:d})}).blur(function(){var i=$(this);if(!Date.isValid(i.val())){alert(GanttMaster.messages.INVALID_DATE_FORMAT);i.val(i.getOldValue())}else{d(Date.parseString(i.val()))}});l.find("#duration").change(function(){var p=Date.parseString(l.find("#start").val());var o=$(this);var i=parseInt(o.val());i=i<=0?1:i;o.val(i);l.find("#end").val(new Date(computeEndByDuration(p.getTime(),i)).format())});l.find("#addAssig").click(function(){var o=l.find("#assigsTable");var i=$.JST.createFromTemplate({task:k,assig:{id:"tmp_"+new Date().getTime()}},"ASSIGNMENT_ROW");o.append(i)});l.find("#status").click(function(){var o=$(this);var i=$.JST.createFromTemplate({},"CHANGE_STATUS");i.find("[status="+k.status+"]").addClass("selected");i.find(".taskStatus").click(function(p){p.stopPropagation();o.attr("status",$(this).attr("status"));i.remove()});o.oneTime(3000,"hideChanger",function(){i.remove()});o.append(i)});l.find("#saveButton").click(function(){var i=g.master.getTask(m);g.master.beginTransaction();i.name=l.find("#name").val();i.description=l.find("#description").val();i.code=l.find("#code").val();i.progress=parseFloat(l.find("#progress").val());i.duration=parseInt(l.find("#duration").val());i.startIsMilestone=l.find("#startIsMilestone").is(":checked");i.endIsMilestone=l.find("#endIsMilestone").is(":checked");l.find("tr[assigId]").each(function(){var v=$(this);var p=v.attr("assigId");var t=v.find("[name=resourceId]").val();var u=v.find("[name=roleId]").val();var q=millisFromString(v.find("[name=effort]").val());var r=false;for(var s=0;s<i.assigs.length;s++){var o=i.assigs[s];if(p==o.id){o.effort=q;o.roleId=u;o.resourceId=t;o.touched=true;r=true;break}else{if(u==o.roleId&&t==o.resourceId){o.effort=q;o.touched=true;r=true;break}}}if(!r){var o=i.createAssignment("tmp_"+new Date().getTime(),t,u,q);o.touched=true}});i.assigs=i.assigs.filter(function(o){var p=o.touched;delete o.touched;return p});i.setPeriod(Date.parseString(l.find("#start").val()).getTime(),Date.parseString(l.find("#end").val()).getTime()+(3600000*24));i.changeStatus(l.find("#status").attr("status"));if(g.master.endTransaction()){$("#__blackpopup__").trigger("close")}})}var f=createBlackPage(800,500).append(l)};