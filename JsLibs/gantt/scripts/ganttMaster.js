function GanttMaster(){this.tasks=[];this.deletedTaskIds=[];this.links=[];this.editor;this.gantt;this.element;this.resources;this.roles;this.minEditableDate=0;this.maxEditableDate=Infinity;this.canWriteOnParent=true;this.canWrite=true;this.firstDayOfWeek=Date.firstDayOfWeek;this.currentTask;this.__currentTransaction;this.__undoStack=[];this.__redoStack=[];this.__inUndoRedo=false;var a=this}GanttMaster.prototype.init=function(a){this.element=a;var b=this;$("#gantEditorTemplates").loadTemplates().remove();this.editor=new GridEditor(this);a.append(this.editor.gridified);this.gantt=new Ganttalendar("m",new Date().getTime()-3600000*24*2,new Date().getTime()+3600000*24*15,this,a.width()*0.6);var c=$.splittify.init(a,this.editor.gridified,this.gantt.element,60);b.splitter=c;a.before($.JST.createFromTemplate({},"GANTBUTTONS"));a.bind("refreshTasks.gantt",function(){b.redrawTasks()}).bind("refreshTask.gantt",function(d,f){b.drawTask(f)}).bind("deleteCurrentTask.gantt",function(d){b.deleteCurrentTask()}).bind("addAboveCurrentTask.gantt",function(){b.addAboveCurrentTask()}).bind("addBelowCurrentTask.gantt",function(){b.addBelowCurrentTask()}).bind("indentCurrentTask.gantt",function(){b.indentCurrentTask()}).bind("outdentCurrentTask.gantt",function(){b.outdentCurrentTask()}).bind("moveUpCurrentTask.gantt",function(){b.moveUpCurrentTask()}).bind("moveDownCurrentTask.gantt",function(){b.moveDownCurrentTask()}).bind("zoomPlus.gantt",function(){b.gantt.zoomGantt(true)}).bind("zoomMinus.gantt",function(){b.gantt.zoomGantt(false)}).bind("undo.gantt",function(){if(!b.canWrite){return}b.undo()}).bind("redo.gantt",function(){if(!b.canWrite){return}b.redo()}).bind("resize.gantt",function(){b.resize()});$("body").bind("keydown.body",function(d){if(d.target.nodeName.toLowerCase()=="body"||d.target.nodeName.toLowerCase()=="svg"){var f=true;switch(d.keyCode){case 46:case 8:var g=b.gantt.element.find(".focused.focused");if(g.is(".taskBox")){b.deleteCurrentTask()}else{if(g.is(".linkGroup")){b.removeLink(g.data("from"),g.data("to"))}}break;case 38:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.moveUpCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}else{b.currentTask.rowElement.prev().click()}}break;case 40:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.moveDownCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}else{b.currentTask.rowElement.next().click()}}break;case 39:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.indentCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}}break;case 37:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.outdentCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}}break;case 89:if(d.ctrlKey){b.redo()}break;case 90:if(d.ctrlKey){b.undo()}break;default:f=false}if(f){d.preventDefault();d.stopPropagation()}}})};GanttMaster.messages={CANNOT_WRITE:"CANNOT_WRITE",CHANGE_OUT_OF_SCOPE:"NO_RIGHTS_FOR_UPDATE_PARENTS_OUT_OF_EDITOR_SCOPE",START_IS_MILESTONE:"START_IS_MILESTONE",END_IS_MILESTONE:"END_IS_MILESTONE",TASK_HAS_CONSTRAINTS:"TASK_HAS_CONSTRAINTS",GANTT_ERROR_DEPENDS_ON_OPEN_TASK:"GANTT_ERROR_DEPENDS_ON_OPEN_TASK",GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK:"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK",TASK_HAS_EXTERNAL_DEPS:"TASK_HAS_EXTERNAL_DEPS",GANTT_ERROR_LOADING_DATA_TASK_REMOVED:"GANTT_ERROR_LOADING_DATA_TASK_REMOVED",CIRCULAR_REFERENCE:"CIRCULAR_REFERENCE",ERROR_SETTING_DATES:"ERROR_SETTING_DATES",CANNOT_DEPENDS_ON_ANCESTORS:"CANNOT_DEPENDS_ON_ANCESTORS",CANNOT_DEPENDS_ON_DESCENDANTS:"CANNOT_DEPENDS_ON_DESCENDANTS",INVALID_DATE_FORMAT:"INVALID_DATE_FORMAT",GANTT_QUARTER_SHORT:"GANTT_QUARTER_SHORT",GANTT_SEMESTER_SHORT:"GANTT_SEMESTER_SHORT",CANNOT_CLOSE_TASK_IF_OPEN_ISSUE:"CANNOT_CLOSE_TASK_IF_OPEN_ISSUE"};GanttMaster.prototype.createTask=function(d,f,a,e,g,b){var c=new TaskFactory();return c.build(d,f,a,e,g,b)};GanttMaster.prototype.createResource=function(a,b){var c=new Resource(a,b);return c};GanttMaster.prototype.updateDependsStrings=function(){for(var b=0;b<this.tasks.length;b++){this.tasks[b].depends=""}for(var b=0;b<this.links.length;b++){var c=this.links[b];var a=c.to.depends;c.to.depends=c.to.depends+(c.to.depends==""?"":",")+(c.from.getRow()+1)+(c.lag?":"+c.lag:"")}};GanttMaster.prototype.removeLink=function(b,d){this.beginTransaction();var a=false;for(var c=0;c<this.links.length;c++){if(this.links[c].from==b&&this.links[c].to==d){this.links.splice(c,1);a=true;break}}if(a){this.updateDependsStrings();if(this.updateLinks(d)){this.changeTaskDates(d,d.start,d.end)}}this.endTransaction()};GanttMaster.prototype.addTask=function(f,e){f.master=this;var c=-1;for(var a=0;a<this.tasks.length;a++){if(f.id==this.tasks[a].id){c=a;break}}if(c>=0){this.tasks.splice(c,1);e=parseInt(c)}if(typeof(e)!="number"){this.tasks.push(f)}else{this.tasks.splice(e,0,f);this.updateDependsStrings()}var b=!this.updateLinks(f);if(f.getParent()){f.status=f.getParent().status}else{f.status="STATUS_ACTIVE"}var d=f;if(b||!f.setPeriod(f.start,f.end)){this.tasks.splice(f.getRow(),1);d=undefined}else{this.editor.addTask(f,e);this.gantt.addTask(f)}return d};GanttMaster.prototype.loadProject=function(a){this.beginTransaction();this.resources=a.resources;this.roles=a.roles;this.canWrite=a.canWrite;this.canWriteOnParent=a.canWriteOnParent;this.cannotCloseTaskIfIssueOpen=a.cannotCloseTaskIfIssueOpen;if(a.minEditableDate){this.minEditableDate=computeStart(a.minEditableDate)}else{this.minEditableDate=-Infinity}if(a.maxEditableDate){this.maxEditableDate=computeEnd(a.maxEditableDate)}else{this.maxEditableDate=Infinity}this.loadTasks(a.tasks,a.selectedRow);this.deletedTaskIds=[];this.endTransaction();var b=this;this.gantt.element.oneTime(200,function(){b.gantt.centerOnToday()})};GanttMaster.prototype.loadTasks=function(h,e){var a=new TaskFactory();this.reset();for(var b=0;b<h.length;b++){var g=h[b];if(!(g instanceof Task)){var f=a.build(g.id,g.name,g.code,g.level,g.start,g.duration);for(var c in g){if(c!="end"&&c!="start"){f[c]=g[c]}}g=f}g.master=this;this.tasks.push(g)}for(var b=0;b<this.tasks.length;b++){var g=this.tasks[b];var d=!this.updateLinks(g);if(d||!g.setPeriod(g.start,g.end)){alert(GanttMaster.messages.GANNT_ERROR_LOADING_DATA_TASK_REMOVED+"\n"+g.name+"\n"+(d?GanttMaster.messages.CIRCULAR_REFERENCE:GanttMaster.messages.ERROR_SETTING_DATES));this.tasks.splice(g.getRow(),1)}else{this.editor.addTask(g);this.gantt.addTask(g)}}this.editor.fillEmptyLines();if(this.tasks&&this.tasks.length>0){e=e?e:0;this.tasks[e].rowElement.click()}};GanttMaster.prototype.getTask=function(c){var b;for(var a=0;a<this.tasks.length;a++){var d=this.tasks[a];if(d.id==c){b=d;break}}return b};GanttMaster.prototype.getResource=function(c){var d;for(var a=0;a<this.resources.length;a++){var b=this.resources[a];if(b.id==c){d=b;break}}return d};GanttMaster.prototype.changeTaskDates=function(c,b,a){return c.setPeriod(b,a)};GanttMaster.prototype.moveTask=function(b,a){return b.moveTo(a,true)};GanttMaster.prototype.taskIsChanged=function(){var a=this;this.element.stopTime("gnnttaskIsChanged");this.element.oneTime(50,"gnnttaskIsChanged",function(){a.editor.redraw();a.gantt.refreshGantt()})};GanttMaster.prototype.redraw=function(){this.editor.redraw();this.gantt.refreshGantt()};GanttMaster.prototype.reset=function(){this.tasks=[];this.links=[];this.deletedTaskIds=[];if(!this.__inUndoRedo){this.__undoStack=[];this.__redoStack=[]}else{this.__inUndoRedo=false}delete this.currentTask;this.editor.reset();this.gantt.reset()};GanttMaster.prototype.showTaskEditor=function(b){var a=this.getTask(b);a.rowElement.find(".edit").click()};GanttMaster.prototype.saveProject=function(){return this.saveGantt(false)};GanttMaster.prototype.saveGantt=function(b){var e=[];for(var c=0;c<this.tasks.length;c++){var f=this.tasks[c];var a=f.clone();delete a.master;delete a.rowElement;delete a.ganttElement;e.push(a)}var d={tasks:e};if(this.currentTask){d.selectedRow=this.currentTask.getRow()}d.deletedTaskIds=this.deletedTaskIds;if(!b){d.resources=this.resources;d.roles=this.roles;d.canWrite=this.canWrite;d.canWriteOnParent=this.canWriteOnParent}return d};GanttMaster.prototype.updateLinks=function(l){function d(v,u,x){if(u==v){return true}var t=v.getSuperiors();var r=v.getParent();while(r){t=t.concat(r.getSuperiors());r=r.getParent()}var j=v.getChildren();for(var o=0;o<j.length;o++){t=t.concat(j[o].getSuperiors())}var q=false;for(var o=0;o<t.length;o++){var s=t[o];if(s.from==u){q=true;break}else{if(x.indexOf(s.from.id+"x"+u.id)<=0){x.push(s.from.id+"x"+u.id);if(d(s.from,u,x)){q=true;break}}}}var w=u.getParent();if(w){if(x.indexOf(v.id+"x"+w.id)<=0){x.push(v.id+"x"+w.id);if(d(v,w,x)){q=true}}}return q}this.links=this.links.filter(function(j){return j.to!=l});var m=true;if(l.depends){var i=l.getParents();var c=l.getDescendant();var b=l.depends.split(",");var g="";var n=[];for(var e=0;e<b.length;e++){var a=b[e];var h=a.split(":");var f=0;if(h.length>1){f=parseInt(h[1])}var k=this.tasks[parseInt(h[0]-1)];if(k){if(i&&i.indexOf(k)>=0){this.setErrorOnTransaction(l.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_ANCESTORS+"\n"+k.name);m=false}else{if(c&&c.indexOf(k)>=0){this.setErrorOnTransaction(l.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_DESCENDANTS+"\n"+k.name);m=false}else{if(d(k,l,n)){m=false;this.setErrorOnTransaction(GanttMaster.messages.CIRCULAR_REFERENCE+"\n"+l.name+" -> "+k.name)}else{this.links.push(new Link(k,l,f));g=g+(g.length>0?",":"")+a}}}}}if(m){l.depends=g}}return m};GanttMaster.prototype.moveUpCurrentTask=function(){var a=this;if(!a.canWrite){return}if(a.currentTask){a.beginTransaction();a.currentTask.moveUp();a.endTransaction()}};GanttMaster.prototype.moveDownCurrentTask=function(){var a=this;if(!a.canWrite){return}if(a.currentTask){a.beginTransaction();a.currentTask.moveDown();a.endTransaction()}};GanttMaster.prototype.outdentCurrentTask=function(){var b=this;if(!b.canWrite||!b.currentTask.canWrite){return}if(b.currentTask){var a=b.currentTask.getParent();b.beginTransaction();b.currentTask.outdent();b.endTransaction();if(a){b.editor.refreshExpandStatus(a)}}};GanttMaster.prototype.indentCurrentTask=function(){var a=this;if(!a.canWrite||!a.currentTask.canWrite){return}if(a.currentTask){a.beginTransaction();a.currentTask.indent();a.endTransaction()}};GanttMaster.prototype.addBelowCurrentTask=function(){var d=this;if(!d.canWrite){return}var b=new TaskFactory();d.beginTransaction();var a;var c=0;if(d.currentTask){a=b.build("tmp_"+new Date().getTime(),"","",d.currentTask.level+1,d.currentTask.start,1);c=d.currentTask.getRow()+1}else{a=b.build("tmp_"+new Date().getTime(),"","",0,new Date().getTime(),1)}var e=d.addTask(a,c);if(e){e.rowElement.click();e.rowElement.find("[name=name]").focus()}d.endTransaction()};GanttMaster.prototype.addAboveCurrentTask=function(){var d=this;if(!d.canWrite){return}var b=new TaskFactory();var a;var c=0;if(d.currentTask){if(d.currentTask.level<=0){return}a=b.build("tmp_"+new Date().getTime(),"","",d.currentTask.level,d.currentTask.start,1);c=d.currentTask.getRow()}else{a=b.build("tmp_"+new Date().getTime(),"","",0,new Date().getTime(),1)}d.beginTransaction();var e=d.addTask(a,c);if(e){e.rowElement.click();e.rowElement.find("[name=name]").focus()}d.endTransaction()};GanttMaster.prototype.deleteCurrentTask=function(){var c=this;if(!c.currentTask||!c.canWrite||!c.currentTask.canWrite){return}var b=c.currentTask.getRow();if(c.currentTask&&(b>0||c.currentTask.isNew())){var a=c.currentTask.getParent();c.beginTransaction();c.currentTask.deleteTask();c.currentTask=undefined;c.updateDependsStrings();c.redraw();if(a){c.editor.refreshExpandStatus(a)}b=b>c.tasks.length-1?c.tasks.length-1:b;if(b>=0){c.currentTask=c.tasks[b];c.currentTask.rowElement.click();c.currentTask.rowElement.find("[name=name]").focus()}c.endTransaction()}};GanttMaster.prototype.beginTransaction=function(){if(!this.__currentTransaction){this.__currentTransaction={snapshot:JSON.stringify(this.saveGantt(true)),errors:[]}}else{console.error("Cannot open twice a transaction")}return this.__currentTransaction};GanttMaster.prototype.endTransaction=function(){if(!this.__currentTransaction){console.error("Transaction never started.");return true}var e=true;if(this.__currentTransaction.errors.length<=0){this.__undoStack.push(this.__currentTransaction.snapshot);this.__redoStack=[];this.gantt.originalStartMillis=Infinity;this.gantt.originalEndMillis=-Infinity;for(var b=0;b<this.tasks.length;b++){var f=this.tasks[b];if(this.gantt.originalStartMillis>f.start){this.gantt.originalStartMillis=f.start}if(this.gantt.originalEndMillis<f.end){this.gantt.originalEndMillis=f.end}}this.taskIsChanged()}else{e=false;var d=JSON.parse(this.__currentTransaction.snapshot);this.deletedTaskIds=d.deletedTaskIds;this.loadTasks(d.tasks,d.selectedRow);this.redraw();var c="";for(var b=0;b<this.__currentTransaction.errors.length;b++){var a=this.__currentTransaction.errors[b];c=c+a.msg+"\n\n"}alert(c)}this.__currentTransaction=undefined;this.editor.refreshExpandStatus(this.currentTask);return e};GanttMaster.prototype.setErrorOnTransaction=function(a,b){if(this.__currentTransaction){this.__currentTransaction.errors.push({msg:a,task:b})}else{console.error(a)}};GanttMaster.prototype.checkpoint=function(){this.__undoStack=[];this.__redoStack=[]};GanttMaster.prototype.undo=function(){if(this.__undoStack.length>0){var a=this.__undoStack.pop();this.__redoStack.push(JSON.stringify(this.saveGantt()));var b=JSON.parse(a);this.deletedTaskIds=b.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(b.tasks,b.selectedRow);this.redraw()}};GanttMaster.prototype.redo=function(){if(this.__redoStack.length>0){var a=this.__redoStack.pop();this.__undoStack.push(JSON.stringify(this.saveGantt()));var b=JSON.parse(a);this.deletedTaskIds=b.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(b.tasks,b.selectedRow);this.redraw()}};GanttMaster.prototype.resize=function(){this.splitter.resize()};GanttMaster.prototype.getCollapsedDescendant=function(){var a=this.tasks;var b=[];for(var c=0;c<a.length;c++){var d=a[c];if(b.indexOf(d)>=0){continue}if(d.collapsed){b=b.concat(d.getDescendant())}}return b};GanttMaster.prototype.computeCriticalPath=function(){if(!this.tasks){return false}var s=this.tasks.filter(function(i){return !i.isParent()});for(var g=0;g<s.length;g++){var q=s[g];q.earlyStart=-1;q.earlyFinish=-1;q.latestStart=-1;q.latestFinish=-1;q.criticalCost=-1;q.isCritical=false}var c=[];var o=s.concat();while(o.length>0){var n=false;for(var g=0;g<o.length;g++){var r=o[g];var h=r.getInferiorTasks();if(e(c,h)){var f=0;for(var m=0;m<h.length;m++){var q=h[m];if(q.criticalCost>f){f=q.criticalCost}}r.criticalCost=f+r.duration;c.push(r);o.splice(g,1);n=true}}if(!n){console.error("Cyclic dependency, algorithm stopped!");return false}}d(s);var k=l(s);b(k);a(s);return s;function e(t,u){for(var j=0;j<u.length;j++){if(t.indexOf(u[j])<0){return false}}return true}function d(w){var u=-1;for(var j=0;j<w.length;j++){var v=w[j];if(v.criticalCost>u){u=v.criticalCost}}for(var j=0;j<w.length;j++){var v=w[j];v.setLatest(u)}}function l(u){var t=[];for(var j=0;j<u.length;j++){if(!u[j].depends||u[j].depends==""){t.push(u[j])}}return t}function b(u){for(var j=0;j<u.length;j++){var t=u[j];t.earlyStart=0;t.earlyFinish=t.duration;p(t)}}function p(w){var j=w.earlyFinish;var v=w.getInferiorTasks();for(var u=0;u<v.length;u++){var x=v[u];if(j>=x.earlyStart){x.earlyStart=j;x.earlyFinish=j+x.duration}p(x)}}function a(v){for(var j=0;j<v.length;j++){var u=v[j];u.isCritical=(u.earlyStart==u.latestStart)}}};