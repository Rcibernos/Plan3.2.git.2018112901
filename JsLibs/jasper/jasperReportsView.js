var JRSClient;var JRSPreview;var myReport={};var utils={};var visualizeReport={create:function create(a){utils={jrsUrl:a.jrsUrl,jrsAuth:a.jrsAuth,reportUri:a.reportUri,reportAppName:a.appName,reportUserName:a.userName,reportId:a.idReport,params_plan:a.params_plan};visualizeReport.init()},init:function init(){$("#container_preview").html("");myReport.app=utils.reportAppName;myReport.user_name=utils.reportUserName;myReport.name="";myReport.reportUri=utils.reportUri;myReport.id=utils.reportId;myReport.inputcontrols=[];myReport.components=[];myReport.params=[];myReport.conditions=[];myReport.charts=[];myReport.operatorTypes={};$.getScript(utils.jrsUrl+"/client/visualize.js",function(){visualizeReport.launchVisualizeJs()});visualizeReport.addEvents()},addEvents:function addEvents(){$("#container_preview").on("click",".applyFilters",function(a){visualizeReport.applyFiltersPreviewReport()})},launchVisualizeJs:function launchVisualizeJs(){console.log("Entramos en launchVisualizeJs");visualize({server:utils.jrsUrl,auth:utils.jrsAuth,},function(a){JRSClient=a;if(myReport.id!=""){myReportsView.getReport(myReport.id)}else{JRSClient.inputControls({resource:myReport.reportUri,success:function(b){visualizeReport.getInputControlsReport(b);visualizeReport.previewReport()}})}},function(){alert("Unexpected error!")});console.log("Terminamos en launchVisualizeJs")},getInputControlsReport:function getInputControlsReport(a){console.log("Empezamos getInputControlsReport");console.log(a);$.each(a,function(c,b){var d={id:b.id,label:b.label,type:b.type,description:b.description,options:[],filter:[],visible:b.visible};if("options" in b.state){$.each(b.state.options,function(){var e={label:this.label,value:this.value,selected:this.selected};d.options.push(e)})}myReport.inputcontrols.push(d)});console.log("Termianmos getINputControlsReport")},previewReport:function previewReport(){$("#container_preview").html("");$("#container_preview").append("<div id='container_preview_params'/>");$("#container_preview").append("<div id='container_preview_report'/>");console.log("Empezamos previewReport Create parameters in filters div");var a=false;$.each(myReport.inputcontrols,function(d,e){if(e.visible){a=true;var g=0;if(e.hasOwnProperty("options")){g=e.options.length}var b;var c;switch(e.type){case"singleSelect":case"singleSelectRadio":b="<select/>";c={id:e.id,name:e.id,type:"select-one","data-param-id":e.id};break;case"multiSelectCheckbox":case"multiSelect":b="<select/>";c={id:e.id,name:e.id,type:"select-multiple",multiple:"multiple","data-param-id":e.id};break;case"singleValueDatetime":case"singleValueDate":b="<input/>";c={id:e.id,name:e.id,label:e.label,type:"date","data-param-id":e.id};break;default:b="<input/>";c={id:e.id,type:e.type,"data-param-id":e.id}}var i="<label>{label}</label>",f=i.replace("{label}",e.label);$("#container_preview_params").append($(f));var h=$(b,c).appendTo("#container_preview_params");$("#container_preview_params").append("</br>");switch(e.type){case"singleSelect":case"singleSelectRadio":case"multiSelectCheckbox":case"multiSelect":$.each(e.options,function(){h.append($("<option />",{value:this.value,text:this.label}))});break}}});$("#container_preview_params").append("</br>");$("#container_preview_params").append("<button class='applyFilters'>Filtrar</button>");visualizeReport.applyConditionsPreviewReport();console.log("Terminamos previewReport Create parameters in filters div")},applyConditionsPreviewReport:function applyConditionsPreviewReport(){var c={};for(var b in myReport.params){c[b]=myReport.params[b];$("[data-param-id]").each(function(e,f){if($(f).attr("data-param-id")==b){var d=$(f).val();if(d!==null&f.localName=="select"){$(f).value=c[b]}else{if(d!==null&f.localName=="input"){var g=[];g.push($(f).val());c[$(f).attr("data-param-id")]=g}}}})}$.each(utils.params_plan,function(d,e){va=[];va.push(e.value);c[e.name]=va});myReport.params=c;console.log(c);JRSPreview=JRSClient.report({resource:myReport.reportUri,container:"#container_preview_report",params:c,error:a,success:function(){}});function a(d){alert(d.message)}},applyFiltersPreviewReport:function applyFiltersPreviewReport(){var b={};$("[data-param-id]").each(function(d,e){var c=$(e).val();if(c!==null&e.localName=="select"){if(Array.isArray(c)){b[$(e).attr("data-param-id")]=c}else{var f=[];f.push($(e).val());b[$(e).attr("data-param-id")]=f}console.log("pasa por select");console.log($(e))}else{if(c!==null&e.localName=="input"){var f=[];f.push($(e).val());b[$(e).attr("data-param-id")]=f;console.log("pasa por input")}}});$.each(utils.params_plan,function(c,d){va=[];va.push(d.value);b[d.name]=va});console.log(b);JRSPreview.params(b).run().fail(a);function a(c){alert(c.message)}}};var myReportsView={getReport:function getReport(a){$.ajax({url:restServer+"report",data:JSON.stringify({app:myReport.app,identity:myReport.user_name,id:a}),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){console.log(b);myReport=JSON.parse(b);myReport.id=a;myReport.reportUri=myReport.report.uri;visualizeReport.previewReport()},error:function(b,c,d){alert(b.responseText+"  "+b.status)}})}};