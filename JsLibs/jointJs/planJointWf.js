joint.shapes.html={};joint.shapes.html.Element=joint.shapes.basic.Rect.extend({defaults:joint.util.deepSupplement({type:"html.Element",attrs:{rect:{stroke:"none","fill-opacity":0}}},joint.shapes.basic.Rect.prototype.defaults)});joint.shapes.html.ElementView=joint.dia.ElementView.extend({template:['<div class="html-element" style="display:table-row; ">',' <!--<span class="button hideshow">&nbsp;</span>-->',' <div class="cabecera">','	<div class="modalmenu">','		<div class="PWiconoCss close_contenedor"></div>','		<div class="info id"></div>','		<div class="separator"></div>','		<div class="button edit">Editar nombre</div>','		<div class="button openform">Abrir</div>','		<div class="button delete">Eliminar</div>','		<div class="separator"></div>','		<div class="button addnextpath">Añadir Camino</div>','		<div class="button addsamepath">Añadir Bucle</div>','		<div class="button addnextstop">Añadir Fase</div>','		<div class="separator"></div>','		<div class="button export">Exportar</div>',"	</div>"," </div>",' <div class="FsTitle">',"  <label></label>",'  <textarea class="txtInput" style="width:100%" value="" ></textarea>','  <div><div class="hidd" style="display:none"></div></div>'," </div>",' <div class="FsContent">','  <div><span class="FsId">Id</span><span class="FsLevel">Lv</span></div>','  <span class="FsRol">Rol</span>','  <span class="FsFormName">Formulario</span>'," </div>","</div>"].join(""),initialize:function(){_.bindAll(this,"updateBox");joint.dia.ElementView.prototype.initialize.apply(this,arguments);this.$box=$(_.template(this.template)());this.$box.find("textarea,select,a").on("mousedown click",function(a){a.stopPropagation()});this.$box.find("textarea").on("change",_.bind(function(a){joint_actualizar(this)},this));this.$box.find("textarea").on("blur",_.bind(function(a){joint_lostfocus(this)},this));this.$box.find("textarea").attr("maxlength","100");if(!(EsExplorer()||EsEdge())){this.$box.find("textarea").on("keyup",_.bind(function(a){joint_ajustaTamanioXtextArea(this)},this))}this.$box.find("select").on("change",_.bind(function(a){this.model.set("select",$(a.target).val())},this));this.$box.find("select").val(this.model.get("select"));this.$box.find(".hideshow").on("click",_.bind(function(a){joint_hideshow(this)},this));this.$box.find(".addnextpath").on("click",_.bind(function(a){joint_crearNewPath(this,"next");joint_contextMenuHide()},this.model));this.$box.find(".addsamepath").on("click",_.bind(function(a){joint_crearNewPath(this,"loop");joint_contextMenuHide()},this.model));this.$box.find(".addnextstop").on("click",_.bind(function(a){joint_crearNewStop(this,"next");joint_contextMenuHide()},this.model));this.$box.find(".edit").on("click",_.bind(function(a){joint_editar(this);joint_contextMenuHide()},this));this.$box.find(".openform").on("click",_.bind(function(a){joint_openform(this)},this));this.$box.find(".export").on("click",_.bind(function(a){joint_export(this);joint_contextMenuHide()},this));this.$box.find(".organize").on("click",_.bind(function(a){joint_organize(this);joint_contextMenuHide()},this));this.$box.find(".cabecera .modalmenu").mouseleave(function(){$(this).parent().parent()[0].style.zIndex="2";$(this).parent().hide()});this.$box.find(".close_contenedor").on("click",_.bind(function(a){joint_contextMenuHide(this)},this));this.model.on("change",this.updateBox,this);this.model.on("remove",this.removeBox,this);this.model.on("add",this.addBox,this);this.model.on("edit",this.editBox,this);this.$box.find(".html-element").prevObject.get(0).id="H"+this.model.id;this.model.myView=this;this.updateBox()},render:function(){joint.dia.ElementView.prototype.render.apply(this,arguments);this.paper.$el.prepend(this.$box);this.updateBox();joint_ajustaTamanio(this);return this},updateBox:function(){var b=this.model.graph;this.$box.find(".delete").unbind("click");if(this.sePuedeBorrar()){this.$box.find(".delete").show().on("click",_.bind(function(d){joint_borrarPlan(this);joint_contextMenuHide()},this))}else{this.$box.find(".delete").hide()}var a=this.model.getBBox();if(this.esPrimero()){this.$box.addClass("inicio")}else{if(this.esFinOk()){this.$box.addClass("fin ok")}else{if(this.esFinKo()){this.$box.addClass("fin ko")}}}this.$box.find("label").html(joint_textarea2HTML(this.model.get("label")));this.$box.find("hidd").html(joint_textarea2HTML(this.model.get("hidd")));this.$box.find("textarea").val(this.model.get("label"));this.$box.find(".FsId").html("Id:"+this.model.get("fsid"));this.$box.find(".info.id").html("Id:"+this.model.get("fsid"));this.$box.find(".FsLevel").html("Lv:"+this.model.get("fslevel"));this.$box.find(".FsRol").html("R:"+this.model.get("fsrol"));this.$box.find(".FsFormName").html("F:"+this.model.get("fsformname"));this.$box.addClass(this.model.get("tipo"));this.$box.display="inline";this.$box.css({width:a.width,height:a.height,left:a.x,top:a.y,transform:"rotate("+(this.model.get("angle")||0)+"deg)"});if(this.model.graph.edit){if(this.model.graph.edit.id==this.model.id){this.$box.find(".edit").click()}}this.$box.removeClass("jointCollapsed");this.$box.removeClass("jointExpanded");if(joint_haveSucessors(this.model)){if(joint_isCollapsed(this.model)){this.$box.addClass("jointCollapsed")}else{this.$box.addClass("jointExpanded")}}this.$box.find(".button.edit").text(b.literals.ledit);this.$box.find(".button.organize").text(b.literals.lorganize);this.$box.find(".button.delete").text(b.literals.ldel);this.$box.find(".button.undo").text(b.literals.lundo);this.$box.find(".button.redo").text(b.literals.lredo);if(this.myWFType()=="rs"){this.$box.find(".button.addnextpath").remove();this.$box.find(".button.addsamepath").remove();if(b.getConnectedLinks(this.model,{outbound:true}).length>0){this.$box.find(".button.addnextstop").hide()}else{this.$box.find(".button.addnextstop").show()}this.$box.find(".button.addnextstop").text(b.literals.lnextstop)}else{this.$box.find(".button.addnextpath").text(b.literals.lnextpath);this.$box.find(".button.addsamepath").text(b.literals.lsamepath);this.$box.find(".button.addnextstop").remove()}},myWFType:function(){return this.model.attributes.tipo},removeBox:function(a){this.$box.remove()},hideBox:function(a){this.$box.hide()},showBox:function(a){this.$box.show()},addBox:function(a){alert(3)},editBox:function(a){alert("EditBox")},sePuedeBorrar:function(){if(this.esRs()){return true}if(this.esPrimero()){return false}return(this.model.graph.getConnectedLinks(this.model).length<=0)},esRs:function(){return(this.model.get("tipo")=="rs")},esFs:function(){return(this.model.get("tipo")=="fs")},esPrimero:function(){return this.model.get("primero")},esFinOk:function(){return this.model.get("fin")=="1"},esFinKo:function(){return this.model.get("fin")=="2"},fsId:function(){return this.model.get("fsid")},tipo:function(){return this.model.get("tipo")},collapsedContent:null});var joint_move=false;var joint_timer=null;var joint_paperMove=false;var joint_FsDims={width:120,height:90,sep:90,sepx:50};var joint_RsDims={width:80,height:30,sep:90,sepx:50};function joint_export(b){var a=document.getElementById(b.model.graph.myControl);domtoimage.toPng(a).then(function(f){var d=$("<a>").attr("href",f).attr("download","img.png").appendTo("body");d[0].click();d.remove()}).catch(function(d){console.error("something went wrong!",d)})}function Joint_DeleteArrows(f){if(f.attributes.tipo!="rs"){return}var a=f.graph;var b=a.getConnectedLinks(f,{outbound:true});for(var d=0;d<b.length;d++){b[d].remove()}}function joint_hideshow(n){var o=n.model;if(o.graph.edit){joint_forcelostfocus()}var d=o.graph.getSuccessors(o);if(d.length>0){var j=joint_isCollapsed(o);if(!j){var a=[];for(var h=0;h<d.length;h++){var b=d[h];var l=joint_getSourceLink(b);if(o.graph.selectedElement){if(o.graph.selectedElement.id==b.id){o.graph.selectedElement=null;joint_actualizaSeleccion(o.graph)}}if($("#H"+b.id).css("display")!="none"){var k={id:b.id,lkId:null};a.push(k);$("#H"+b.id).hide();if(l){k.lkId=l.id;$("g[model-id="+l.id+"]").hide()}}}o.set("collapsedContent",a)}else{var f=o.get("collapsedContent");for(var h=0;h<f.length;h++){var k=f[h];$("#H"+k.id).show();$("g[model-id="+k.lkId+"]").show()}o.set("collapsedContent",[])}}else{o.set("collapsedContent",null)}n.updateBox();joint_status2Plan(o.graph)}function joint_isCollapsed(b){if(b.graph.getSuccessors(b).length<=0){return false}var a=b.get("collapsedContent");if(!a){return false}return(a.length>0)}function joint_isSoonOfCollapsed(a){var b=joint_getPadre(a);if(!b){return false}if(joint_isCollapsed(b)){return true}return joint_isSoonOfCollapsed(b)}function joint_restoreCollapsed(d){var b=d.getElements();for(e=0;e<b.length;e++){if(joint_isCollapsed(b[e])){var a=b[e].get("collapsedContent");for(var f=0;f<a.length;f++){var h=a[f];$("#H"+h.id).hide();$("g[model-id="+h.lkId+"]").hide()}}}if(d.selectedElement){$("#H"+d.selectedElement.id).addClass("selected")}if(!d.edit){joint_paperFocus($("#"+d.myControl).get(0),d)}}function joint_organize(i){return;var f=i.model.graph;joint_forcelostfocus(f,null);var d=f.getFirstCell();joint_organizeR(10,10,d);var a=f.getElements();var b=joint_subGraphDimension(a);var h=document.getElementById(f.myControl).offsetHeight;if(b.height<h){joint_redimensionar(a,0,(h-b.height)/2)}joint_ajustePaper(f);joint_actualizaSeleccion(f);joint_status2Plan(f);joint_scrollTo(d)}function joint_organizeR(w,x,h){var l=h.graph;var z=0;var d;var a=0;var u=0;var b=l.getSuccessors(h);var n=0;var k=[];for(var n=0;n<b.length;n++){if(!joint_haveSucessors(b[n])){d=joint_FsDims;a=b[n].get("size").height;u=d.sep;z+=a+u}}var s=w;if(b.length==0){var t=x}else{var t=(z/2)+x}h.position(s,t);var p=0;var q=s+h.attributes.size.width+joint_FsDims.sepx;var r=x;var o=getInmediateSuccessors(h);for(var p=0;p<o.length;p++){var f=o[p];joint_organizeR(q,r,f);var v=joint_subGraphDimension(joint_getSubGraph(f));r+=joint_FsDims.sep+v.height}}function joint_editar(a){var b=a.model;a.$box.find("label").css("display","none");if(EsExplorer()){a.$box.find("textarea").css("display","inline-block").focus()}else{a.$box.find("textarea").css("display","inline-block").focus().select()}b.graph.edit=b}function joint_actualizar(a){var b=a.$box.find("textarea").val();if(a.model.get("label")!=b){a.$box.find("label").html(joint_textarea2HTML(b));a.model.set("label",b);joint_status2Plan(a.model.graph);joint_Element2Plan(a.model)}}function joint_desactualizar(b){var a=b.get("label");b.myView.$box.find("textarea").val(a);b.myView.$box.find("label").html(joint_textarea2HTML(a))}function joint_undoEdit(b){var a=b.getElements();for(var d=0;d<a.length;d++){if(a[d].myView){if(a[d].myView.$box.find("textarea").css("display")!="none"){joint_desactualizar(a[d])}}}}function joint_forcelostfocus(f,b){var a=null;if(b){a=b.id}else{f.edit=null}var d=f.getElements();for(var h=0;h<d.length;h++){if(a!=d[h].id){joint_lostfocus(d[h].myView)}}joint_paperFocus($("#"+f.myControl).get(0),f)}function joint_lostfocus(b){if(!b){return}if(!b.model){return}var d=b.model;var a=d.graph;if(b.$box.find("textarea").css("display")=="none"){return}joint_actualizar(b);b.$box.find("textarea").css("display","none");b.$box.find("label").css("display","inline-block");joint_ajustaTamanio(b);a.edit=null;joint_status2Plan(a);joint_paperFocus($("#"+a.myControl).get(0),a)}function joint_lineBreak(d){if(!d.edit){return}var b=d.getElements();for(var f=0;f<b.length;f++){if(b[f].myView){var i=b[f].myView;if(i.$box.find("textarea").css("display")!="none"){var j=i.$box.find("textarea");var a=j.val();var h=j.prop("selectionStart");if(h>=0&&a.length>h){a=a.substring(0,h)+"\n"+a.substring(h,a.length)}else{a+="\n"}j.val(a);j.prop("selectionStart",h+1);j.prop("selectionEnd",h+1)}}}}function joint_HTML2Textarea(a){if(a){return a.split("<br/>").join("\n").split("&lt;br/&gt;").join("\n")}else{return""}}function joint_textarea2HTML(a){if(a){return a.split("\n").join("<br/>").split("&lt;br/&gt;").join("<br/>")}else{return""}}function getInmediateSuccessors(d){var a=d.graph.getSuccessors(d,{breadthFirst:true,depth:false});var f=[];for(var b=0;b<a.length;b++){if(d.graph.isNeighbor(d,a[b])){f.push(a[b])}}return f}function getInmediatePredecessors(d){var a=d.graph.getPredecessors(d,{breadthFirst:true,depth:false});var f=[];for(var b=0;b<a.length;b++){if(d.graph.isNeighbor(d,a[b])){f.push(a[b])}}return f}function getLevel(f,d,h){if(d===null){d=0}if(!h){h={}}if(h[f.id]){return d}else{h[f.id]=true}var j=f.graph.getFirstCell();if(f===j){return d}var a=getInmediatePredecessors(f);for(var b=0;b<a.length;b++){return getLevel(a[b],d+1,h)}return 0}function joint_getPadre(a){var b=a.graph.getNeighbors(a,{inbound:true,outbound:false});if(b.length>0){return b[0]}return null}function joint_getXid(d,a){var b=d.getCells();for(Xid=0;Xid<b.length;Xid++){if(b[Xid].id==a){return b[Xid]}}}function array_push(d,f){for(var b=0;b<f.length;b++){d.push(f[b])}}function joint_sortY(a){if(!a){return null}a.sort(function(d,f){if(d){return d.attributes.position.y-f.attributes.position.y}});return a}function joint_getXlevel(b,d){var a=b.getElements();var f=[];for(m=0;m<a.length;m++){if(getLevel(a[m],0)==d){f.push(a[m])}}return joint_sortY(f)}function joint_getPrev(b){var d=joint_getXlevel(b.graph,getLevel(b,0));for(var a=0;a<d.length;a++){if(d[a].id==b.id){if(a>0){return d[a-1]}}}return null}function joint_getPost(b){var d=joint_getXlevel(b.graph,getLevel(b,0));for(var a=0;a<d.length;a++){if(d[a].id==b.id){if(a<(d.length-1)){return d[a+1]}}}return null}function joint_childOf(d,f){pre=d.graph.getPredecessors(d);for(var a=0;a<pre.length;pre++){if(pre[a].id==f.id){return true}}return false}function joint_haveSucessors(a){var b=a.graph.getSuccessors(a);if(b){return(b.length>0)}return false}function joint_getSourceLink(d){var a=d.graph.getLinks();for(var b=0;b<a.length;b++){if(a[b].attributes.target.id==d.id){return a[b]}}return null}function joint_getSubGraph(b){var a=b.graph.getSuccessors(b);a.unshift(b);return a}function joint_restOfGraph(d,b){var a=d.getElements();var h=[];for(var f=0;f<a.length;f++){if(!joint_subGraphContains(b,a[f].id)){h.push(a[f])}}return joint_sortY(h)}function joint_subGraphContains(b,a){for(var d=0;d<b.length;d++){if(b[d].id==a){return true}}return false}function joint_subGraphDimension(a){if(!a){a=[]}if(a.length==0){return{width:0,height:0,x:0,y:0}}var l=null;var f=-999999;var h=-999999;var i=999999;var j=999999;for(var k=0;k<a.length;k++){var b=a[k];var p=b.get("position").x;var q=b.get("position").y;var o=b.get("size").width;var d=b.get("size").height;if(!l){l={width:o,height:d,x:p,y:q}}if(f<=p+o){f=p+o}if(h<=q+d){h=q+d}if(i>=p){i=p}if(j>=q){j=q}}return{width:f-i,height:h-j,x:i,y:j}}function centroH(a){var b=document.getElementById(a).offsetHeight;return(b/2)-(joint_FsDims.height/2)}function centroW(a){var b=document.getElementById(a).offsetWidth;return(b/2)-(joint_FsDims.width/2)}function joint_status2Plan(a){if(a){var b=JSON.stringify(a);$("#"+a.myControlVal).val(b);return b}}function joint_serialize(b){var a=b.pilas;b.pilas={};var d=JSON.stringify(b);joint_status2Plan(b);b.pilas=a;return d}function joint_deserialize(h,a){var b=h.pilas;var f=h.selectedElement;var d=h.myControl;h.clear();h.fromJSON(JSON.parse(a));h.edit=null;h.pilas=b;h.myControl=d;h.selectedElement=f;joint_restoreCollapsed(h);joint_restoreSelected(h);joint_actualizaSeleccion(h);joint_ajustePaper(h)}function joint_findXid(b,f){var a=b.getElements();for(var d=0;d<a.length;d++){if(a[d].id==f){return a[d]}}return null}function Stack(){var b=[];this.add=a;this.pop=h;this.getTopElement=d;this.hasElements=f;this.removeAll=i;this.size=j;function a(k){b.push(k)}function h(){return b.pop()}function d(){return b[b.length-1]}function f(){return b.length>0}function i(){b=[]}function j(){return b.length}}function joint_restoreSelected(a){if(a.selectedElement){a.selectedElement=joint_findXid(a,a.selectedElement.id)}}function joint_actualizaSeleccion(b){var a=b.getElements();for(var d=0;d<a.length;d++){$("#H"+a[d].id).removeClass("selected")}if(b.selectedElement){$("#H"+b.selectedElement.id).addClass("selected")}joint_paperFocus($("#"+b.myControl).get(0),b)}function joint_clickOnCellView(a){a.model.graph.edit=null;$(".html-element textarea:focus").blur();a.model.graph.selectedElement=a.model;joint_actualizaSeleccion(a.model.graph);joint_forcelostfocus(a.model.graph,a.model)}function joint_redimensionar(b,f,h){for(var d=0;d<b.length;d++){var a=b[d];a.translate(f,h)}}function joint_ajustePaper(b){if(!b){return}els=b.getElements();var n=0;var o=0;var f=0;for(var d=0;d<els.length;d++){var a=els[d];var h=joint_FsDims;if(n<a.get("position").x+a.get("size").width+h.sepx){var n=a.get("position").x+a.get("size").width+h.sepx}if(o<a.get("position").y+a.get("size").height+h.sep){var o=a.get("position").y+a.get("size").height+h.sep}if(f>a.get("position").y){f=a.get("position").y}}var i=document.getElementById(b.myControl);var j=i.clientWidth;var l=i.clientHeight;if(j<n){i.style.width=""+(n)+"px"}if(l<o){i.style.height=""+(o)+"px"}if(f<0){i.style.height=""+(i.clientHeight-(f))+"px";joint_redimensionar(els,0,-(f))}}function joint_getSupOf(d,b){var f=[];for(c=0;c<b.length;c++){var a=b[c];if(a.id==d.id){continue}if(a.get("position").y<d.get("position").y){f.push(a)}}return f}function joint_getInfOf(h,d){var f=[];for(var a=0;a<d.length;a++){var b=d[a];if(b.id==h.id){continue}if(b.get("position").y>h.get("position").y){f.push(b)}}return f}function joint_getLeftOf(f,b){var d=[];for(c=0;c<b.length;c++){var a=b[c];if(a.id==f.id){continue}if(a.get("position").x<f.get("position").x){d.push(a)}}return d}function joint_getRightOf(f,d){var h=[];for(var a=0;a<d.length;a++){var b=d[a];if(b.id==f.id){continue}if(b.get("position").x>f.get("position").x){h.push(b)}}return h}function joint_hazHuecoY(d,f){var h=joint_getSubGraph(d);var a=joint_restOfGraph(d.graph,h);var i=joint_getSupOf(d,a);var b=joint_getInfOf(d,a);joint_redimensionar(i,0,(-f));joint_redimensionar(b,0,(+f))}function joint_hazHuecoX(d,h){var i=joint_getSubGraph(d);var a=joint_restOfGraph(d.graph,i);var b=joint_getLeftOf(d,a);var f=joint_getRightOf(d,a);joint_redimensionar(b,(-h),0);joint_redimensionar(f,(+h),0)}function joint_scrollTo(b){var a=document.getElementById(b.graph.myControl).offsetTop;var d=document.getElementById("H"+b.id).offsetTop;document.getElementById(b.graph.myControl).scrollTop=(a-d)}function joint_ajustaTamanio(a){if(a.model.attributes.tipo=="rs"){joint_ajustaTamanioRs(a)}joint_ajustaTamanioFs(a)}function joint_ajustaTamanioRs(f){var a=false;var d=f.model.graph;var h=f.$box.get(0).clientHeight;var i=f.$box.find(".FsTitle>label").get(0).clientHeight;if(i+10>h){f.model.get("size").height+=((i+10)-h);a=true}else{if(i+15<h){f.model.get("size").height+=((i+15)-h);if(f.model.get("size").height<joint_RsDims.height){f.model.get("size").height=joint_RsDims.height}a=true}}if(a){f.updateBox()}if(f.model.resizeX){var b=joint_serialize(d);joint_deserialize(d,b);f.model.resizeX=0}}function joint_ajustaTamanioFs(f){var a=false;var d=f.model.graph;var h=f.$box.get(0).clientHeight;var i=f.$box.find(".FsTitle>label").get(0).clientHeight+f.$box.find(".FsContent").get(0).clientHeight;if(i+20>h){f.model.get("size").height+=((i+10)-h);a=true}else{if(i+30<h){f.model.get("size").height+=((i+15)-h);if(f.model.get("size").height<joint_FsDims.height){f.model.get("size").height=joint_FsDims.height}a=true}}if(a){f.updateBox()}if(f.model.resizeX){var b=joint_serialize(d);joint_deserialize(d,b);f.model.resizeX=0}}function joint_ajustaTamanioXtextArea(d){var a=d.model.graph;var j=d.$box.find("textarea").get(0);var i=j.scrollWidth;var h=j.offsetWidth;if(!d.model.resizeX){d.model.resizeX=0}if(i>(h)){j.style.width=""+i+"px";var k=d.model.get("size").width;d.model.get("size").width=(i+20);d.model.resizeX=true;d.$box.css("width",""+(i+20)+"px")}else{var f=j.value;var l=joint_adjust2TextWidth(d,j);d.model.get("size").width=(l+20);d.model.resizeX=true;d.$box.css("width",""+(l+20)+"px")}var b=j.offsetWidth;console.log("....newtow>"+b+" tow ="+h);joint_redimensionar(a.getSuccessors(d.model),(b-h),0)}function joint_adjust2TextWidth(d,a){var f=a.offsetWidth;var b=(d.model.attributes.tipo=="fs"?joint_FsDims.width:joint_RsDims.width)-20;while(a.scrollWidth==a.offsetWidth&&a.offsetWidth>b){a.style.width=""+(a.offsetWidth-5)+"px";f=a.offsetWidth}a.style.width=""+(a.offsetWidth+5)+"px";return a.offsetWidth}function joint_crearNewPath(f,h){var b=(h=="loop"?f:null);var a=joint_Plan2NewElement(f,b,"rs");var d=joint_crearNewElement(f,b,joint_RsDims,RSplan_2_info(a),"rs",h);joint_Element2Plan(d)}function joint_crearNewStop(b,d){var a=joint_Plan2NewElement(b,null,"fs");Joint_DeleteArrows(b);joint_Element2Plan(joint_crearNewElement(b,null,joint_FsDims,FSplan_2_info(a),"fs",d))}function joint_crearNewElement(o,a,k,j,s,p){var r=getInmediateSuccessors(o);var q=r.length;var l=o.get("position").x+((o.get("size").width-k.width)/2);var n=o.get("position").y+o.get("size").height+k.sep;for(var h=0;h<q;h++){var f=(r[h].get("position").x+r[h].get("size").width+k.sepx);var b=r[h].get("position").y;if(b<o.get("position").y){continue}l=(f>l?f:l)}var d=joint_crearHTMLElement(l,n,k.width,k.height,j);o.graph.addCells([d,joint_crearLink(o,d)]);if(a){o.graph.addCells([joint_crearLink(d,a)])}var h=0;joint_ajustePaper(o.graph);o.graph.selectedElement=d;joint_forcelostfocus(o.graph,d);joint_actualizaSeleccion(o.graph);o.graph.edit=d;if(d.myView){d.myView.updateBox()}if(o.myView){o.myView.updateBox()}joint_status2Plan(o.graph);joint_scrollTo(d);return d}function joint_crearHTMLElement(h,i,f,d,a){var b=new joint.shapes.html.Element({position:{x:h,y:i},size:{width:f,height:d},label:a.title,fsid:a.fsid,fslevel:a.nivel,fsrol:a.rol,fsformname:a.formname,bid:"H"+a.fsid,select:"two",primero:a.pri,tipo:a.tipo,fin:a.fin,ports:{groups:{agroup:{position:"top",attrs:{circle:{fill:"none",stroke:"#000","stroke-width":1,r:1,magnet:false}}},bgroup:{position:"bottom",attrs:{circle:{fill:"#000",stroke:"#000","stroke-width":1,r:1,magnet:false}}},lgroup:{position:"left",attrs:{circle:{fill:"#000",stroke:"#000","stroke-width":1,r:1,magnet:false}}},rgroup:{position:"right",attrs:{circle:{fill:"#000",stroke:"#000","stroke-width":1,r:1,magnet:false}}}}}});return b}function joint_crearLink(h,a,f,b){var d=new joint.dia.Link({source:{id:h.id,port:f},target:{id:a.id,port:b},router:{name:"manhattan"},connector:{name:"rounded",args:{radius:30}},attrs:{".connection":{stroke:"#333","stroke-width":1},".marker-source":{fill:"#300",d:"M 0 10 L 10 5 L 0 0 z"},".marker-target":{fill:"#333",d:"M 10 1 L 0 5 L 10 10 z"},".link-tools":{display:"none"},".marker-vertices":{display:"none"},".marker-arrowheads":{display:"none"},".connection-wrap":{display:"none"}},outPorts:["out"]});return d}function joint_changeDestFs(a,i){var b=a.model.graph;joint_forcelostfocus(b);if(!(a.esRs()&&i.myView.esFs())){return false}var h=b.getConnectedLinks(a.model,{outbound:true});if(h.length>0){return false}var d=false;if(confirm(b.literals.lconfirmnewdest)){var j=b.WF;var f={fCont:j.fCont,cpCont:j.cpCont,idVsesion:document.getElementById("HiddenCurrentValueFormXPage").value,cCont:j.cCont,rsid:a.fsId(),fsid:i.myView.fsId()};$.ajax({type:"POST",url:cUtilUrlPathName+"/ws/ajxtool.asmx/WFDiagram_changeDest",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(f),success:function(k){k=Resd(k);if(k){alert(k);d=true;return fals3}},error:function(l,n,k){alert("onError.WFDiagram_changeDest."+n+" "+k)},timeout:10000,async:false});if(d){return false}Joint_DeleteArrows(a.model);b.addCell(joint_crearLink(a.model,i));a.updateBox();i.myView.updateBox();b.selectedElement=a.model;joint_actualizaSeleccion(b);a.$box.find(".html-element").focus();joint_status2Plan(b);joint_scrollTo(a.model)}joint_noSuperponer(i,a.model);return true}function joint_noSuperponer(a,k){var i=a.graph;var d=a.get("size").width;var b=a.get("size").height;var f=a.get("position").x+d;var h=a.get("position").y+b;var l=k.get("size").width;var j=k.get("size").height;var n=k.get("position").x+(l/2);var o=k.get("position").y+(j/2);var p=0;var q=0;if(((f-n)>=(d/2))&&((h-o)>=(b/2))){p=a.get("position").x-l-(joint_RsDims.sepx/2);q=a.get("position").y-j-(joint_RsDims.sep/2)}else{if(((f-n)>=(d/2))&&((h-o)<(b/2))){p=a.get("position").x-l-(joint_RsDims.sepx/2);q=h+j+(joint_RsDims.sep/2)}else{if(((f-n)<(d/2))&&((h-o)>=(b/2))){p=f+(joint_RsDims.sepx/2);q=a.get("position").y-j-(joint_RsDims.sep/2)}else{p=f+(joint_RsDims.sepx/2);q=h+j+(joint_RsDims.sep/2)}}}k.position(p,q);joint_ajustePaper(i)}function joint_rebuildGraph(b){if(!b){return}var a=jQuery.data(document.body,b);if(!a){return}if(a.pendiente){if(!$("#"+a.myControl).is(":hidden")){jQuery.data(document.body,b,jointWF_newGraph(a.myControl,a.myControlVal,a.pW,a.pH,a.literals,a.sl,a.WF))}}}function joint_paperFocus(a,b){}function joint_setSl(d,f){if(!d){return}var a=jQuery.data(document.body,d);if(!a){return}if(a.sl==f){return}a.sl=(f?true:false);var b=($("#"+a.myControl).is(":hidden"));if(!b){a.clear();jQuery.data(document.body,d,jointWF_newGraph(a.myControl,a.myControlVal,a.pW,a.pH,a.literals,a.sl))}else{a.pendiente=true;a.clear()}}function joint_contextMenu(a,b,d){joint_contextMenuHide();if(a.$box){a.$box[0].style.zIndex=3;a.$box.find(".cabecera").show();a.$box.find(".cabecera .modalmenu")[0].style.left=""+(b-5-a.model.get("position").x)+"px";a.$box.find(".cabecera .modalmenu")[0].style.top=""+(d-5-a.model.get("position").y)+"px"}}function joint_contextMenuHide(){$(".html-element .cabecera .modalmenu").mouseleave();joint_timer=null}function jointWF_newGraph(a,b,o,k,i,p,q){var f=new joint.dia.Graph();f.selectedElement=null;f.firstElement=null;f.WF=q;f.myControl=a;f.myControlVal="WFDIAG_"+b;f.myControlHdVal="WFDIAGEdtVal_"+b;f.myControlHdBt="WFDIAGEdtB_"+b;f.pW=o;f.pH=k;f.sl=(p?true:false);if(!i){i={lnextpath:"Añadir siguiente",lsamepath:"Añadir bucle",lnextstop:"Añadir Parada",ledit:"Editar título",lorganize:"Reorganiza gráfico",ldel:"Eliminar",lundo:"Deshacer acción",lredo:"Rehacer acción",lnewfstitle:"Nombre fase",lnewrstitle:"Nombre camino",laceptar:"Aceptar",lcancelar:"Cancelar",lconfirmdel:"Se va a borrar el nodo ¿Está seguro?",lconfirmnewdest:"Se va cambiar la fase de destino ¿Está seguro?"}}f.literals=i;f.PWCreaFaseXRespuesta=function(r){return{label:f.literals.lnewfstitle}};f.PWCreaRespuestaXFase=function(s,r,t){return{label:f.literals.lnewrstitle}};if(EsExplorer()||EsEdge()){$("#"+a).addClass("PtEx")}if($("#"+a).is(":hidden")){f.pendiente=true;return f}f.pendiente=false;var n=new Stack();var l=new Stack();var h=null;f.pilas={PUndo:n,PRedo:l,S:h};o=(o?o:800);k=(k?k:500);var j=new joint.dia.Paper({el:$("#"+a),width:o,height:k,gridSize:10,model:f});if(f.sl){j.setInteractivity(false);$("#"+f.myControl).removeAttr("tabindex").off("keypress").off("mouseover").off("keydown").off("keypress")}else{j.on("cell:contextmenu",function(r,s,t,u){joint_contextMenu(r,t,u)});j.on("cell:pointerdown",function(r,s,t,u){r.miX=t;r.miY=u;joint_timer=Date.now()});j.on("cell:pointermove",function(r,s,t,u){if(!r.model.attributes.position){return}if(!joint_move){joint_forcelostfocus(r.model.graph)}joint_move=true;joint_timer=null});j.on("cell:pointerup",function(r,u,v,w){if(joint_move){joint_move=false;joint_status2Plan(r.model.graph);var t=r.model.graph.get("cells").find(function(x){if(x instanceof joint.dia.Link){return false}if(x.id===r.model.id){return false}if(x.getBBox().containsPoint(g.point(v,w))){return true}return false});if(t){joint_changeDestFs(r,t)}joint_ajustePaper(r.model.graph);joint_forcelostfocus(r.model.graph);joint_Element2Plan(r.model)}if(joint_timer){var s=Date.now()-joint_timer;if(s>500){joint_contextMenu(r,v,w)}joint_timer=null}joint_clickOnCellView(r)});j.on("cell:pointerdblclick",function(r,s,t,u){joint_editar(r)});j.on("cell:pointerclick",function(r,s,t){joint_clickOnCellView(r)});j.on("blank:pointerclick",function(r,s,t){$(".html-element textarea:focus").blur();joint_forcelostfocus(f);joint_contextMenuHide(this)});j.on("blank:pointerdown",function(r,s,t){joint_paperMove=true;joint_paperMoveX=s;joint_paperMoveY=t});j.on("blank:pointermove",function(t,w,z){if(!joint_paperMove){return}var u=$("body").parent().scrollLeft();var v=$("body").parent().scrollTop();var r=u+(joint_paperMoveX-w);var s=v+(joint_paperMoveY-z);joint_paperMoveX=w;joint_paperMoveY=z;$("body").parent().scrollLeft((r<0?0:r));$("body").parent().scrollTop((s<0?0:s))});j.on("blank:pointerup",function(r,s,t){joint_paperMove=false;joint_paperMoveX=0;joint_paperMoveY=0})}var d=centroW(a);if(f.WF){joint_crearWF(f,d,10)}return f}function joint_crearWF(j,u,v){var t=j.WF;var f={};var r={};for(var l=0;l<t.fases.length;l++){var d=t.fases[l];var s=d.ancho<joint_FsDims.width?joint_FsDims.width:d.ancho;var k=d.alto<joint_FsDims.height?joint_FsDims.height:d.alto;var b=joint_crearHTMLElement(d.x,d.y,s,k,FSplan_2_info(d));b.graph=j;j.addCells([b]);f[d.id]=b}t.respuestas.sort(function(h,i){return h.x-i.x});for(var l=0;l<t.respuestas.length;l++){try{var q=t.respuestas[l];var s=q.ancho<joint_RsDims.width?joint_RsDims.width:q.ancho;var k=q.alto<joint_RsDims.height?joint_RsDims.height:q.alto;var b=joint_crearHTMLElement(q.x,q.y,s,k,RSplan_2_info(q));b.graph=j;j.addCells([b]);var o=f[q.origen];var a=f[q.destino];if(o){var p="POde"+q.id;o.addPort({group:joint_detGroup(o,b),id:p});j.addCell(joint_crearLink(o,b,p,null))}if(a){var p="PDde"+q.id;a.addPort({group:joint_detGroup(a,b,(o===a)),id:p});j.addCell(joint_crearLink(b,a,null,p))}r[q.id]=b}catch(n){oldAlert(n)}}for(var l=0;l<t.fases.length;l++){f[t.fases[l].id].myView.updateBox()}for(var l=0;l<t.respuestas.length;l++){r[t.respuestas[l].id].myView.updateBox()}joint_ajustePaper(j);joint_actualizaSeleccion(j);joint_status2Plan(j)}function joint_detGroup(a,d,b){if(b){if(a.attributes.position.x>d.attributes.position.x){return"lgroup"}return"rgroup"}if(a.attributes.position.y>d.attributes.position.y){return"agroup"}return"bgroup"}function joint_Element2Plan(b){var d=b.graph.WF;var a={fCont:d.fCont,cpCont:d.cpCont,idVsesion:document.getElementById("HiddenCurrentValueFormXPage").value,cCont:d.cCont,node:JSON.stringify(b)};$.ajax({type:"POST",url:cUtilUrlPathName+"/ws/ajxtool.asmx/WFDiagram_updateNode",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(f){f=Resd(f);if(f){alert(resObj.mensajeError)}},error:function(h,i,f){alert("onError.WFDiagram_updateNode."+i+" "+f)},timeout:10000,async:true})}function joint_Plan2NewElement(b,d,h){var i=b.graph.WF;var a={fCont:i.fCont,cpCont:i.cpCont,idVsesion:document.getElementById("HiddenCurrentValueFormXPage").value,cCont:i.cCont,tipo:h,origen:b.get("fsid"),destino:(d?d.get("fsid"):null)};var f={};$.ajax({type:"POST",url:cUtilUrlPathName+"/ws/ajxtool.asmx/WFDiagram_createNode",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(j){j=Resd(j);if(j){f=j}},error:function(k,l,j){alert("onError.WFDiagram_createNode."+l+" "+j)},timeout:10000,async:false});return JSON.parse(f)}function joint_borrarPlan(a){var f=a.model;var b=f.graph;if(b.edit){return false}if(!a.sePuedeBorrar()){return false}if(!confirm(b.literals.lconfirmdel)){return}var i=f.graph.WF;var d={fCont:i.fCont,cpCont:i.cpCont,idVsesion:document.getElementById("HiddenCurrentValueFormXPage").value,cCont:i.cCont,tipo:a.tipo(),id:a.fsId()};var h={};$.ajax({type:"POST",url:cUtilUrlPathName+"/ws/ajxtool.asmx/WFDiagram_deleteNode",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(d),success:function(o){o=Resd(o);if(o){alert(o)}else{var k=b.getConnectedLinks(f);f.remove();for(var j=0;j<k.length;j++){var n=k[j];if(n.target()){if(n.target().id){if(n.target().id!=f.id){joint_updateBox(b,n.target().id)}}}if(n.source()){if(n.source().id){if(n.source().id!=f.id){joint_updateBox(b,n.source().id)}}}}joint_actualizaSeleccion(b);joint_status2Plan(b)}},error:function(k,l,j){alert("onError.WFDiagram_deleteNode."+l+" "+j)},timeout:10000,async:false})}function FSplan_2_info(a){return{title:a.title,rol:a.rol,formname:a.formname,nivel:a.nivel,fsid:a.id,pri:a.inicio,fin:a.tipofin,tipo:"fs"}}function RSplan_2_info(a){return{title:a.title,fsid:a.id,pri:false,fin:"0",tipo:"rs"}}function joint_updateBox(a,d){var b=joint_getXid(a,d);if(b){b.myView.updateBox()}}function joint_openform(d){var a=d.model.graph;var f=d.model.attributes.tipo;var b=d.model.attributes.fsid;$("#"+a.myControlHdVal).val((f+b));document.getElementById(a.myControlHdBt).click()};